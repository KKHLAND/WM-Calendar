<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>학사일정</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    
    <!-- XLSX 라이브러리 추가 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
      /* Basic CSS Reset and Font Smoothing */
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Custom style for responsive calendar header (for multiday events) */
      .grid-rows-auto {
        grid-auto-rows: minmax(100px, 1fr); 
      }
    </style>

    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

    <script>
      // Tailwind CSS Configuration - wait for tailwind to load
      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
              },
            },
          },
        }
      }
      
      const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64.split(',')[1]);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      };
      
      const processExcelFile = (file, callback, onError) => {
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = event.target.result;
                  const workbook = XLSX.read(data, { type: 'binary' });
                  const sheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[sheetName];
                  
                  const csv = XLSX.utils.sheet_to_csv(worksheet, { FS: ',', RS: '\n' });
                  callback(csv);
              } catch (e) {
                  console.error("Error processing Excel file:", e);
                  onError("엑셀 파일을 처리하는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.");
              }
          };
          reader.onerror = (e) => {
              console.error("Error reading file:", e);
              onError("파일을 읽는 중 오류가 발생했습니다.");
          };
          
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
              reader.readAsBinaryString(file);
          } else {
              onError("지원하지 않는 파일 형식입니다.");
          }
      };

      const processCsvFile = (file, callback, onError) => {
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  let text = event.target.result;
                  if (text.charCodeAt(0) === 0xFEFF) {
                      text = text.slice(1);
                  }
                  text = text.replace(/\r\n|\r/g, '\n');
                  callback(text);
              } catch (e) {
                  console.error('파일을 읽는 중 오류가 발생했습니다.', e);
                  onError("CSV 파일을 읽는 중 오류가 발생했습니다.");
              }
          };
          reader.onerror = (e) => {
              console.error("Error reading file:", e);
              onError("파일을 읽는 중 오류가 발생했습니다.");
          };
          reader.readAsText(file);
      };
    </script>
</head>
<body class="bg-gradient-to-br from-sky-200 to-blue-100 p-2 sm:p-4 lg:p-8 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useMemo, useCallback, useEffect } = React;
        
        // --- Error Boundary Component ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-red-50 text-center">
                            <h1 className="text-2xl font-bold text-red-600 mb-4">오류가 발생했습니다</h1>
                            <p className="text-slate-700 mb-6 bg-white p-4 rounded shadow border border-red-200 max-w-lg overflow-auto text-sm text-left">
                                {this.state.error && this.state.error.toString()}
                            </p>
                            <button 
                                onClick={() => window.location.reload()}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors shadow-lg"
                            >
                                페이지 새로고침
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Manual implementation of date-fns functions ---
        const startOfMonth = (date) => {
            const result = new Date(date);
            result.setDate(1);
            result.setHours(0, 0, 0, 0);
            return result;
        };
        
        const endOfMonth = (date) => {
            const result = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            result.setHours(23, 59, 59, 999);
            return result;
        };
        
        const dateFnsStartOfWeek = (date, options = {}) => {
            const weekStartsOn = options.weekStartsOn || 0;
            const result = new Date(date);
            const day = result.getDay();
            const diff = (day < weekStartsOn ? 7 : 0) + day - weekStartsOn;
            result.setDate(result.getDate() - diff);
            result.setHours(0, 0, 0, 0);
            return result;
        };
        
        const endOfWeek = (date, options = {}) => {
            const weekStartsOn = options.weekStartsOn || 0;
            const result = new Date(date);
            const day = result.getDay();
            const diff = (day < weekStartsOn ? -7 : 0) + 6 - (day - weekStartsOn);
            result.setDate(result.getDate() + diff);
            result.setHours(23, 59, 59, 999);
            return result;
        };
        
        const eachDayOfInterval = ({ start, end }) => {
            const days = [];
            const current = new Date(start);
            current.setHours(0, 0, 0, 0);
            const endDate = new Date(end);
            endDate.setHours(0, 0, 0, 0);
            
            while (current <= endDate) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return days;
        };
        
        const format = (date, formatStr) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            if (formatStr === 'MMMM yyyy') {
                return `${monthNames[month]} ${year}`;
            }
            if (formatStr === 'd') {
                return String(day);
            }
            return date.toLocaleDateString();
        };
        
        const isSameMonth = (date1, date2) => {
            return date1.getFullYear() === date2.getFullYear() && 
                   date1.getMonth() === date2.getMonth();
        };
        
        const isToday = (date) => {
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                   date.getMonth() === today.getMonth() &&
                   date.getDate() === today.getDate();
        };
        // --- End of date functions ---

        // --- START: data/schoolData.ts ---
        const DEFAULT_SCHOOL_NAME = '원묵고등학교';
        const DEFAULT_LOGO_DATA_URL = 'https://i.imgur.com/6ZCUaap.jpeg'; 
        
        const rawEventsCsv = `"날짜","행사1","행사2","행사3"
"2026. 2. 11","신학년대비집중연수","학교로찾아오는 컨설팅 AI 연수",""
"2026. 2. 12","신학년대비집중연수","학교로찾아오는 컨설팅 AI 연수",""
"2026. 2. 13","신학년대비집중연수","신입생 예비소집 및 사전 교육(오전)","부서별 교과별 자율연수(오후)"
"2026. 2. 19","입학전 배정 등록","",""
"2026. 3. 3","개학식(2,3)","입학식(1)",""
"2026. 3. 4","자율(상견례/OT(1))","생활안전교육(2,3)",""
"2026. 3. 6","자율","전교직원회의1",""
"2026. 3. 13","자율","",""
"2026. 3. 20","동아리","",""
"2026. 3. 23","학부모총회","1학기수업공개의날(5,6교시)",""
"2026. 3. 24","학력평가(1,2,3)","",""
"2026. 3. 25","교원학습공동체1","",""
"2026. 3. 27","자율","",""
"2026. 3. 30","창의상상 인문 기초1","",""
"2026. 4. 1","보고서 작성법 특강","",""
"2026. 4. 3","봉사활동 사전교육","전교직원회의2",""
"2026. 4. 6","창의상상 인문 정규1","",""
"2026. 4. 8","이공계전문가 초청특강1","",""
"2026. 4. 9","화요일 수업","",""
"2026. 4. 10","학생회장 선거","",""
"2026. 4. 17","동아리","",""
"2026. 4. 24","중간고사-교과협의","",""
"2026. 4. 27","중간고사-부서협의","",""
"2026. 4. 28","중간고사-학년협의","",""
"2026. 4. 29","중간고사-교원학습공동체2","",""
"2026. 4. 30","중간고사","",""
"2026. 5. 6","학교현장실습 시작","비경쟁식 독서 토론","STEAM실험반1"
"2026. 5. 7","학력평가(3)","",""
"2026. 5. 8","학급별 봉사활동","창의상상 인문 기초2","STEAM실험반2"
"2026. 5. 9","창의상상 역사 문화체험","",""
"2026. 5. 11","STEAM실험반3","",""
"2026. 5. 13","STEAM실험반4","",""
"2026. 5. 15","체육한마당","문화체험(3)",""
"2026. 5. 18","창의상상 인문 정규2","STEAM실험반5",""
"2026. 5. 20","독서멘토링 전체 토론일","",""
"2026. 5. 22","동아리","STEAM실험반6",""
"2026. 5. 25","대체공휴일","",""
"2026. 5. 27","교원학습공동체3","",""
"2026. 5. 29","자율","",""
"2026. 6. 1","창의상상 인문 정규3","",""
"2026. 6. 4","학력평가(1,2)","대수능 모평(3)",""
"2026. 6. 5","동아리","",""
"2026. 6. 8","STEAM실험반 발표회","",""
"2026. 6. 10","지독한 독서클럽 전체 토론일","",""
"2026. 6. 12","자율","전교직원회의3",""
"2026. 6. 19","동아리","",""
"2026. 6. 26","자율","",""
"2026. 6. 30","기말고사","",""
"2026. 7. 1","기말고사-교과협의","",""
"2026. 7. 2","기말고사-부서협의","",""
"2026. 7. 3","기말고사-학년협의","",""
"2026. 7. 6","기말고사","교원학습공동체4",""
"2026. 7. 7","선택과목설명회","",""
"2026. 7. 8","학력평가(3)","",""
"2026. 7. 10","자율","최성보 정서적 지원 교육(콘서트)","경제학 특강"
"2026. 7. 13","최성보 정서적 지원 교육(특강)","창의상상 인문 정규4",""
"2026. 7. 15","경제학 특강","",""
"2026. 7. 16","최성보 보충지도 OT","",""
"2026. 7. 20","예술교육발표회","전교직원회의4","방학식"
"2026. 7. 21","과학실험캠프","",""
"2026. 7. 22","4차산업공학캠프","",""
"2026. 8. 13","<개학>","",""
"2026. 8. 14","동아리","전교직원회의5",""
"2026. 8. 19","과학토론마당","논제발표일",""
"2026. 8. 21","동아리","",""
"2026. 8. 24","창의상상 인문 정규5","",""
"2026. 8. 26","과학토론마당","참가 신청 마감일","교원학습공동체5"
"2026. 8. 27","금요일 수업","(동3)",""
"2026. 8. 28","묵향제","",""
"2026. 9. 2","학력평가(1,2)","대수능 모평(3)",""
"2026. 9. 4","교육과정박람회","과학토론마당","개요서제출(예선)"
"2026. 9. 9","독서멘토링 전체 토론일","",""
"2026. 9. 11","학급별 봉사활동","",""
"2026. 9. 16","과학토론마당(본선)","",""
"2026. 9. 18","자율","전교직원회의6",""
"2026. 9. 22","목요일 수업","",""
"2026. 9. 23","과학토론마당(결선)","",""
"2026. 10. 1","중간고사-교과협의","",""
"2026. 10. 2","중간고사-부서협의","",""
"2026. 10. 6","중간고사-학년협의","",""
"2026. 10. 7","중간고사","교원학습공동체6",""
"2026. 10. 8","중간고사","",""
"2026. 10. 14","수련회(1)","일일형 체험활동(2)",""
"2026. 10. 15","수련회(1)","일일형 체험활동(2)",""
"2026. 10. 16","수련회(1)","일일형 체험활동(2)","자율(3)"
"2026. 10. 20","학력평가(1,2,3)","",""
"2026. 10. 21","지독한 독서클럽 토론일","",""
"2026. 10. 23","동아리","독도의 날 행사",""
"2026. 10. 24","수학창의력캠프","",""
"2026. 10. 26","인문탐구 발표","수정원고 마감",""
"2026. 10. 28","이공계전문가","초청특강2",""
"2026. 10. 30","자율","",""
"2026. 11. 2","창의상상 인문 정규6","(인문탐구 발표)",""
"2026. 11. 6","자율","융합 독서캠프",""
"2026. 11. 7","천문우주캠프","",""
"2026. 11. 9","창의상상 인문 예비일","(인문탐구 발표)",""
"2026. 11. 13","자율","",""
"2026. 11. 19","대학수학능력시험(3)","휴업일(1,2)",""
"2026. 11. 20","재량휴업일","",""
"2026. 11. 23","금요일 수업","",""
"2026. 11. 24"," 기말고사(3학년)","",""
"2026. 11. 25","기말고사(3학년)","교원학습공동체7",""
"2026. 11. 26","기말고사(3학년)","",""
"2026. 11. 27","기말고사(3학년)","자율","전교직원회의7"
"2026. 12. 1","목요일 수업","",""
"2026. 12. 4","자율","",""
"2026. 12. 10","기말고사(1,2)","교과협의회",""
"2026. 12. 11","자율(3)","기말고사(1,2)","부서협의회"
"2026. 12. 14","기말고사(1,2)","학년협의회",""
"2026. 12. 15","기말고사(1,2)","",""
"2026. 12. 16","기말고사(1,2)","",""
"2026. 12. 18","*최성보 정서적 지원 교육(골든벨)","",""
"2026. 12. 23","*최성보 정서적 지원 교육(콘서트)","교원학습공동체 8",""
"2026. 12. 24","외국어 노래제","",""
"2026. 12. 28","*최성보 보충지도 OT","끼자랑",""
"2026. 12. 29","예술교육발표회","",""
"2026. 12. 30","전교직원회의8","(3학년 졸업사정안)","<방학식>"
"2027. 2. 1","<개학>","",""
"2027. 2. 3","졸업식(3)","",""
"2027. 2. 4","<종업식(1,2)>","",""
"2027. 2. 17","신학년대비집중연수","",""
"2027. 2. 18","신학년대비집중연수","",""
"2027. 2. 19","신학년대비집중연수","부장기획워크숍",""
`;

        const rawHolidaysCsv = `"날짜","휴일"
"2026-01-01","신정(양력설)"
"2026-02-16","설날 연휴"
"2026-02-17","설날"
"2026-02-18","설날 연휴"
"2026-03-01","3·1절"
"2026-03-02","대체공휴일(3·1절)"
"2026-05-05","어린이날"
"2026-05-01","재량휴업일"
"2026-05-04","재량휴업일"
"2026-05-24","부처님 오신날"
"2026-05-25","대체공휴일(부처님 오신날)"
"2026-06-03","지방선거일"
"2026-06-06","현충일"
"2026-07-17","제헌절"
"2026-08-15","광복절"
"2026-08-17","대체공휴일(광복절)"
"2026-09-24","추석 연휴"
"2026-09-25","추석"
"2026-09-26","추석 연휴"
"2026-10-03","개천절"
"2026-10-05","대체공휴일(개천절)"
"2026-10-09","한글날"
"2026-12-25","크리스마스"
"2027-01-01","신정(양력설)"
"2027-02-06","설날 연휴"
"2027-02-07","설날"
"2027-02-08","설날 연휴"
"2027-02-09","대체공휴일(설날)"
`;

        const rawDutiesCsv = `"날짜","요일","지도교사","종류","비고"
"2026. 3. 2","월","신**","휴일근무","대체공휴일(3·1절)"
`;
        // --- END: data/schoolData.ts ---

        // --- START: utils/dataProcessor.ts ---
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            let cleanedStr = dateStr.replace(/\./g, '-').replace(/\s/g, '');
            let parts = cleanedStr.split('-').filter(p => p);
            
            if (parts.length === 3) {
                const [year, month, day] = parts.map(p => parseInt(p, 10));
                if (!isNaN(year) && year > 1900 && !isNaN(month) && month >= 1 && month <= 12 && !isNaN(day) && day >= 1 && day <= 31) {
                    return new Date(year, month - 1, day); 
                }
            }
            cleanedStr = dateStr.replace(/\./g, '/').replace(/\s/g, '');
            parts = cleanedStr.split('/');
            
            if (parts.length === 3) {
                const [month, day, year] = parts.map(p => parseInt(p, 10));
                if (!isNaN(year) && year > 1900 && !isNaN(month) && month >= 1 && month <= 12 && !isNaN(day) && day >= 1 && day <= 31) {
                    return new Date(year, month - 1, day);
                }
            }
            const date = new Date(dateStr);
            if (date instanceof Date && !isNaN(date)) {
                return date;
            }
            return null;
        };

        const formatDateKey = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        const parseCsvLine = (line) => {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (const char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    fields.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            fields.push(currentField.trim());
            return fields.map(f => f.replace(/^"|"$/g, ''));
        };

        const parseEventsCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const events = [];
            lines.forEach(line => {
                if (!line.trim()) return; 
                const [date, ...eventParts] = parseCsvLine(line);
                const eventStrings = eventParts.map(e => e.trim().replace(/"/g, '')).filter(e => e);
                if (date && eventStrings.length > 0) {
                    events.push({ date, events: eventStrings });
                }
            });
            return events;
        };

        const parseHolidaysCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const holidays = [];
            lines.forEach(line => {
                if (!line.trim()) return; 
                const [dateStr, name] = parseCsvLine(line);
                const date = parseDate(dateStr);
                if (date && name) {
                    holidays.push({ date, name: name.trim() });
                }
            });
            return holidays;
        };

        const parseTeachersCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const duties = [];
            lines.forEach(line => {
                if (!line.trim()) return; 
                const [dateStr, _day, teacher] = parseCsvLine(line);
                const date = parseDate(dateStr);
                if (date && teacher && teacher.trim()) {
                    duties.push({ date, teacher: teacher.trim() });
                }
            });
            return duties;
        };

        const EVENT_COLORS = [
            { bg: 'bg-sky-100', text: 'text-sky-900' },
            { bg: 'bg-emerald-100', text: 'text-emerald-900' },
            { bg: 'bg-amber-100', text: 'text-amber-900' },
            { bg: 'bg-violet-100', text: 'text-violet-900' },
            { bg: 'bg-rose-100', text: 'text-rose-900' },
            { bg: 'bg-lime-100', text: 'text-lime-900' },
            { bg: 'bg-indigo-500', text: 'text-white' },
            { bg: 'bg-emerald-600', text: 'text-white' },
            { bg: 'bg-pink-400', text: 'text-white' },
            { bg: 'bg-orange-500', text: 'text-white' }
        ];

        const simpleHash = (str) => {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0; 
          }
          return Math.abs(hash);
        };
        
        const getEventColor = (eventTitle) => {
            const activityKeywords = ['자율', '적응', '동아리', '봉사'];
            const activityColor = 'bg-teal-500 text-white'; 
            
            for (const keyword of activityKeywords) {
                if (eventTitle.includes(keyword)) {
                    return activityColor;
                }
            }

            const specialKeywords = {
                '고사': 'bg-red-500 text-white font-bold',
                '평가': 'bg-red-500 text-white font-bold',
                '시험': 'bg-red-500 text-white font-bold', 
                '방학': 'bg-blue-500 text-white',
                '개학': 'bg-blue-500 text-white',
                '졸업': 'bg-purple-500 text-white',
                '입학': 'bg-purple-500 text-white',
            };

            for (const keyword in specialKeywords) {
                if (eventTitle.includes(keyword)) {
                    return specialKeywords[keyword];
                }
            }
            
            const themedKeywords = [
                { keywords: ['인문', '독서'], color: 'bg-purple-600 text-white' },
                { keywords: ['과학'], color: 'bg-blue-600 text-white' },
                { keywords: ['예술', '미술', '음악'], color: 'bg-rose-500 text-white' },
                { keywords: ['체육', '스포츠', '수련회'], color: 'bg-lime-600 text-white' },
                { keywords: ['교원', '교직원회의', '연수', '협의회'], color: 'bg-yellow-500 text-white' }
            ];
    
            for (const theme of themedKeywords) {
                for (const keyword of theme.keywords) {
                    if (eventTitle.includes(keyword)) {
                        return theme.color;
                    }
                }
            }

            const hash = simpleHash(eventTitle);
            const color = EVENT_COLORS[hash % EVENT_COLORS.length];
            return `${color.bg} ${color.text}`;
        };

        const findAndProcessMultiDayEvents = (dayDataMap) => {
            const multiDayEvents = [];
            const processedEventIds = new Set();

            const sortedDates = Array.from(dayDataMap.keys()).sort();

            for (const dateKey of sortedDates) {
                const dayData = dayDataMap.get(dateKey);
                if (!dayData) continue;

                for (const event of dayData.events) {
                    const eventId = `${dateKey}_${event.fullTitle}`;
                    if (processedEventIds.has(eventId)) continue;

                    const baseTitleMatch = event.fullTitle.match(/^(.*?)(\s*\d+일차|\s*\(\d+\)|1일차)?$/);
                    const baseTitle = baseTitleMatch ? baseTitleMatch[1].trim() : event.fullTitle;
                    
                    if (!baseTitle) continue;

                    let endDate = new Date(dayData.date);
                    const currentRunEventIds = [eventId];

                    let currentCheckDate = new Date(dayData.date);
                    currentCheckDate.setDate(currentCheckDate.getDate() + 1);
                    let nextDateKey = formatDateKey(currentCheckDate);

                    while (dayDataMap.has(nextDateKey)) {
                        const nextDayData = dayDataMap.get(nextDateKey);
                        const nextDayEvent = nextDayData.events.find(e => {
                             const nextBaseTitleMatch = e.fullTitle.match(/^(.*?)(\s*\d+일차|\s*\(\d+\))?$/);
                             return nextBaseTitleMatch && nextBaseTitleMatch[1].trim() === baseTitle;
                        });

                        if (nextDayEvent) {
                            endDate = new Date(nextDayData.date);
                            currentRunEventIds.push(`${nextDateKey}_${nextDayEvent.fullTitle}`);
                        } else {
                            break;
                        }
                        currentCheckDate.setDate(currentCheckDate.getDate() + 1);
                        nextDateKey = formatDateKey(currentCheckDate);
                    }
                    
                    if (endDate > dayData.date) {
                        multiDayEvents.push({
                            id: `${baseTitle}_${formatDateKey(dayData.date)}`,
                            start: dayData.date,
                            end: endDate,
                            title: baseTitle,
                            color: getEventColor(event.fullTitle),
                        });
                        currentRunEventIds.forEach(id => processedEventIds.add(id));
                    }
                }
            }
            
            const laneManagedEvents = [];
            multiDayEvents.sort((a,b) => a.start.getTime() - b.start.getTime());

            for (const event of multiDayEvents) {
                let lane = 0;
                while(true) {
                    const conflictingEvent = laneManagedEvents.find(e => e.lane === lane && !(event.start > e.end || event.end < e.start));
                    if (!conflictingEvent) {
                        laneManagedEvents.push({ ...event, lane });
                        break;
                    }
                    lane++;
                }
            }

            return { multiDayEvents: laneManagedEvents, processedEventIds };
        };


        const processCalendarData = (rawEvents, holidays, duties, userModifiedEvents = {}, userModifiedDuties = {}) => {
            const dayDataMap = new Map();

            // 1. 기본 학사일정 이벤트 처리 (우선 맵에 등록)
            rawEvents.forEach(rawEvent => {
                const date = parseDate(rawEvent.date);
                if (date) {
                    const key = formatDateKey(date);
                    if (!dayDataMap.has(key)) {
                        dayDataMap.set(key, { date, events: [], holiday: null, teacherDuty: null, isUserModified: false });
                    }
                    const dayData = dayDataMap.get(key);
                    rawEvent.events.forEach(eventTitle => {
                        dayData.events.push({
                            title: eventTitle.length > 15 ? eventTitle.substring(0, 12) + '...' : eventTitle,
                            fullTitle: eventTitle,
                            color: getEventColor(eventTitle),
                            isUserEvent: false
                        });
                    });
                }
            });

            // 2. 공휴일 처리
            holidays.forEach(holiday => {
                const key = formatDateKey(holiday.date);
                if (!dayDataMap.has(key)) {
                    dayDataMap.set(key, { date: holiday.date, events: [], holiday: null, teacherDuty: null, isUserModified: false });
                }
                dayDataMap.get(key).holiday = holiday;
            });

            // 3. 당직 교사 처리
            duties.forEach(duty => {
                const key = formatDateKey(duty.date);
                if (!dayDataMap.has(key)) {
                    dayDataMap.set(key, { date: duty.date, events: [], holiday: null, teacherDuty: null, isUserModified: false });
                }
                dayDataMap.get(key).teacherDuty = duty;
            });

            // 4. [변경] 사용자 수정 이벤트 처리 (OVERWRITE LOGIC)
            // 사용자가 수정한 날짜가 있으면, 기존 이벤트를 덮어씌웁니다.
            Object.keys(userModifiedEvents).forEach(dateKey => {
                const userEventList = userModifiedEvents[dateKey];
                
                // 날짜가 맵에 없으면 생성
                if (!dayDataMap.has(dateKey)) {
                    const [year, month, day] = dateKey.split('-').map(Number);
                    dayDataMap.set(dateKey, { 
                        date: new Date(year, month - 1, day), 
                        events: [], 
                        holiday: null, 
                        teacherDuty: null,
                        isUserModified: true 
                    });
                }
                
                const dayData = dayDataMap.get(dateKey);
                
                // 해당 날짜의 이벤트를 사용자 정의 이벤트로 완전히 교체
                dayData.isUserModified = true;
                dayData.events = userEventList.map(eventTitle => ({
                    title: eventTitle.length > 15 ? eventTitle.substring(0, 12) + '...' : eventTitle,
                    fullTitle: eventTitle,
                    color: getEventColor(eventTitle),
                    isUserEvent: true // 사용자가 편집한 상태임을 표시
                }));
            });

            // 5. [신규] 사용자 수정 특별 행사(Duty) 처리
            Object.keys(userModifiedDuties).forEach(dateKey => {
                const userDutyText = userModifiedDuties[dateKey];
                
                 if (!dayDataMap.has(dateKey)) {
                    const [year, month, day] = dateKey.split('-').map(Number);
                    dayDataMap.set(dateKey, { 
                        date: new Date(year, month - 1, day), 
                        events: [], 
                        holiday: null, 
                        teacherDuty: null,
                        isUserModified: true 
                    });
                }

                const dayData = dayDataMap.get(dateKey);
                dayData.isUserModified = true;

                if (userDutyText) {
                    // 기존 duty 객체 구조를 유지하면서 teacher 필드 업데이트
                    dayData.teacherDuty = { 
                        date: dayData.date, 
                        teacher: userDutyText,
                        // 기존 종류/비고가 있다면 유지할 수도 있지만, 여기서는 단순 텍스트 오버라이드로 처리
                        // 원본 데이터가 있으면 그것을 참조할 수도 있으나, 단순화를 위해 텍스트 교체
                    };
                } else {
                    // 빈 문자열로 저장된 경우 삭제 처리 (또는 빈 값 표시)
                    dayData.teacherDuty = null;
                }
            });


            // 6. 멀티데이 이벤트 감지 및 처리
            const { multiDayEvents, processedEventIds } = findAndProcessMultiDayEvents(dayDataMap);

            // 7. 멀티데이 이벤트로 처리된 단일 이벤트 처리 (삭제 대신 숨김 처리)
            for (const [key, dayData] of dayDataMap.entries()) {
                dayData.events.forEach(event => {
                    const eventId = `${key}_${event.fullTitle}`;
                    if (processedEventIds.has(eventId)) {
                        event.isHidden = true; // 렌더링 시 숨김 처리 플래그 (삭제하지 않음)
                    }
                });
            }

            return { dayDataMap, multiDayEvents };
        };
        // --- END: utils/dataProcessor.ts ---

        // --- START: components/ConfirmModal.tsx ---
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel, confirmText = "확인", cancelText = "취소", isDanger = false }) => {
            if (!isOpen) return null;

            return (
                <div 
                    className="fixed inset-0 bg-black/50 z-[60] flex justify-center items-center p-4"
                    onClick={onCancel}
                >
                    <div 
                        className="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 flex flex-col items-center text-center animate-fade-in"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className={`mb-4 p-3 rounded-full ${isDanger ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 className="text-lg font-bold text-slate-800 mb-2">확인 필요</h3>
                        <p className="text-slate-600 text-sm mb-6 whitespace-pre-wrap">{message}</p>
                        <div className="flex gap-3 w-full">
                            <button 
                                onClick={onCancel}
                                className="flex-1 px-4 py-2 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200 transition-colors"
                            >
                                {cancelText}
                            </button>
                            <button 
                                onClick={onConfirm}
                                className={`flex-1 px-4 py-2 text-white font-medium rounded-lg transition-colors shadow-sm ${isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`}
                            >
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        // --- END: components/ConfirmModal.tsx ---

        // --- START: components/EventModal.tsx ---
        const XMarkIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const PlusIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );

        const PencilIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
        );

        const TrashIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const EventModal = ({ dayData, onClose, onSaveUserEvents, userModifiedEvents, onResetDate }) => {
            const { date, events, holiday, teacherDuty, isUserModified } = dayData;
            const dateKey = formatDateKey(date);
            const formattedDate = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            
            const [editingEvents, setEditingEvents] = useState(() => {
                return events.map(e => e.fullTitle);
            });
            
            // 특별 행사(Duty) 편집 상태 추가
            const [editingDuty, setEditingDuty] = useState(() => {
                return teacherDuty ? teacherDuty.teacher : '';
            });

            const [newEventText, setNewEventText] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            const handleAddEvent = () => {
                if (newEventText.trim()) {
                    setEditingEvents([...editingEvents, newEventText.trim()]);
                    setNewEventText('');
                }
            };

            const handleDeleteEvent = (index) => {
                const newEvents = editingEvents.filter((_, i) => i !== index);
                setEditingEvents(newEvents);
            };

            const handleStartEditEvent = (index) => {
                setEditingIndex(index);
                setEditingText(editingEvents[index]);
            };

            const handleSaveEditEvent = () => {
                if (editingText.trim()) {
                    const newEvents = [...editingEvents];
                    newEvents[editingIndex] = editingText.trim();
                    setEditingEvents(newEvents);
                }
                setEditingIndex(null);
                setEditingText('');
            };

            const handleCancelEditEvent = () => {
                setEditingIndex(null);
                setEditingText('');
            };

            // 저장 시 이벤트와 특별 행사 모두 전달
            const handleSave = () => {
                onSaveUserEvents(dateKey, editingEvents, editingDuty);
                onClose();
            };
            
            const handleResetConfirm = () => {
                onResetDate(dateKey);
                onClose();
            }

            return (
                <div 
                    className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4"
                    onClick={onClose}
                >
                    <div 
                        className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[85vh] flex flex-col"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <header className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-lg">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">{formattedDate}</h2>
                                {isUserModified && <span className="text-xs text-blue-600 font-medium">사용자 수정됨</span>}
                            </div>
                            <button onClick={onClose} className="p-1 rounded-full text-slate-400 hover:bg-slate-200 transition-colors">
                                <XMarkIcon />
                            </button>
                        </header>
                        
                        <div className="flex-grow p-4 overflow-y-auto space-y-4">
                            {holiday && (
                                <div className="mb-4">
                                    <h3 className="font-semibold text-slate-700 text-sm mb-1 uppercase tracking-wider">공휴일</h3>
                                    <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <p className="font-bold text-red-700">{holiday.name}</p>
                                    </div>
                                </div>
                            )}

                            <div>
                                <h3 className="font-semibold text-slate-700 text-sm mb-2 uppercase tracking-wider flex justify-between items-center">
                                    일정 목록 (수정 가능)
                                </h3>
                                
                                <div className="space-y-2 mb-4">
                                    {editingEvents.length > 0 ? (
                                        <ul className="space-y-2">
                                            {editingEvents.map((eventText, index) => (
                                                <li key={index} className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200 group hover:border-blue-300 transition-colors">
                                                    {editingIndex === index ? (
                                                        <>
                                                            <input 
                                                                type="text"
                                                                value={editingText}
                                                                onChange={(e) => setEditingText(e.target.value)}
                                                                className="flex-1 px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                autoFocus
                                                                onKeyPress={(e) => e.key === 'Enter' && handleSaveEditEvent()}
                                                            />
                                                            <button onClick={handleSaveEditEvent} className="p-1 bg-green-500 text-white rounded hover:bg-green-600">
                                                                <span className="text-xs px-1">확인</span>
                                                            </button>
                                                            <button onClick={handleCancelEditEvent} className="p-1 bg-slate-300 text-slate-700 rounded hover:bg-slate-400">
                                                                <XMarkIcon className="h-4 w-4"/>
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span className="flex-1 text-sm text-slate-700">{eventText}</span>
                                                            <div className="flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button 
                                                                    onClick={() => handleStartEditEvent(index)}
                                                                    className="p-1.5 text-blue-600 hover:bg-blue-100 rounded"
                                                                    title="수정"
                                                                >
                                                                    <PencilIcon />
                                                                </button>
                                                                <button 
                                                                    onClick={() => handleDeleteEvent(index)}
                                                                    className="p-1.5 text-red-600 hover:bg-red-100 rounded"
                                                                    title="삭제"
                                                                >
                                                                    <TrashIcon />
                                                                </button>
                                                            </div>
                                                        </>
                                                    )}
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <div className="text-center py-6 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-300">
                                            등록된 일정이 없습니다.
                                        </div>
                                    )}
                                </div>

                                <div className="flex items-center gap-2 mb-2">
                                    <input 
                                        type="text"
                                        value={newEventText}
                                        onChange={(e) => setNewEventText(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddEvent()}
                                        placeholder="새 일정 추가..."
                                        className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button 
                                        onClick={handleAddEvent}
                                        disabled={!newEventText.trim()}
                                        className="flex items-center gap-1 px-3 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <PlusIcon />
                                        추가
                                    </button>
                                </div>
                            </div>

                            {/* 특별 행사 / 지도 교사 편집 영역 */}
                             <div className="mt-4 pt-4 border-t border-slate-200">
                                <h3 className="font-semibold text-slate-700 text-sm mb-1 uppercase tracking-wider">특별 행사 / 지도 교사 (수정 가능)</h3>
                                <div className="p-1">
                                    <input 
                                        type="text"
                                        value={editingDuty}
                                        onChange={(e) => setEditingDuty(e.target.value)}
                                        placeholder="특별 행사나 지도교사 정보를 입력하세요"
                                        className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <footer className="p-4 bg-slate-50 border-t border-slate-200 flex justify-between items-center rounded-b-lg">
                            {isUserModified ? (
                                <button
                                    onClick={() => setShowResetConfirm(true)}
                                    className="text-xs text-red-600 hover:text-red-800 underline underline-offset-2"
                                >
                                    기본 일정으로 초기화
                                </button>
                            ) : (
                                <div></div>
                            )}
                            <div className="flex gap-2">
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-2 bg-white border border-slate-300 text-slate-700 text-sm font-semibold rounded-lg hover:bg-slate-50 transition-colors"
                                >
                                    취소
                                </button>
                                <button 
                                    onClick={handleSave}
                                    className="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 shadow-sm transition-colors"
                                >
                                    저장 완료
                                </button>
                            </div>
                        </footer>
                    </div>

                    <ConfirmModal
                        isOpen={showResetConfirm}
                        message="이 날짜의 모든 수정사항(일정 및 특별행사)을 초기화하고 기본 데이터로 되돌리시겠습니까?"
                        onConfirm={handleResetConfirm}
                        onCancel={() => setShowResetConfirm(false)}
                        confirmText="초기화"
                        isDanger={true}
                    />
                </div>
            );
        };
        // --- END: components/EventModal.tsx ---

        // --- START: components/Header.tsx ---
        const ChevronLeftIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
        );

        const ChevronRightIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        );

        const MiniCalendar = ({ date, startOfWeek }) => {
            const monthStart = startOfMonth(date);
            const monthEnd = endOfMonth(date);
            const calendarStart = dateFnsStartOfWeek(monthStart, { weekStartsOn: startOfWeek });
            const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: startOfWeek });
            const days = eachDayOfInterval({ start: calendarStart, end: calendarEnd });

            let dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            if (startOfWeek === 1) {
                dayHeaders.push(dayHeaders.shift()); 
            }

            return (
                <div className="w-48">
                    <h3 className="text-center font-semibold text-sm mb-2 text-slate-700">{format(date, 'MMMM yyyy')}</h3>
                    <div className="grid grid-cols-7 text-center text-xs text-slate-500">
                        {dayHeaders.map(day => <div key={day} className="h-4 flex items-center justify-center">{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7 text-center text-xs mt-1">
                        {days.map(day => {
                            const dayOfWeek = day.getDay();
                            const isCurrentMonth = isSameMonth(day, date);

                            let textColor = 'text-slate-600';
                            if (!isCurrentMonth) {
                                textColor = 'text-slate-300';
                            } else if (dayOfWeek === 0) { // Sunday
                                textColor = 'text-red-500';
                            } else if (dayOfWeek === 6) { // Saturday
                                textColor = 'text-blue-500';
                            }

                            return (
                                <div
                                    key={day.toString()}
                                    className={`
                                        w-6 h-4 flex items-center justify-center rounded-full
                                        ${isToday(day) ? 'bg-blue-600 text-white shadow-md' : textColor}
                                    `}
                                >
                                    {format(day, 'd')}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Header = ({ viewDate, setViewDate, startOfWeek, setStartOfWeek, onReset, onShowDataModal, schoolName, schoolLogo }) => {
            const currentYear = viewDate.getFullYear();
            const currentMonth = viewDate.getMonth();

            const goToPreviousMonth = () => setViewDate(new Date(currentYear, currentMonth - 1, 1));
            const goToNextMonth = () => setViewDate(new Date(currentYear, currentMonth + 1, 1));
            const goToToday = () => setViewDate(new Date());

            const prevMonth = new Date(currentYear, currentMonth - 1, 1);
            const nextMonth = new Date(currentYear, currentMonth + 1, 1);
            
            const selectBaseClasses = "bg-white text-slate-700 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50";
            const buttonBaseClasses = `px-3 py-2 border border-gray-300 bg-white text-slate-700 text-sm font-medium rounded-md shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500`;

            return (
                <header className="bg-white shadow-sm sticky top-0 z-20">
                     <div className="p-2 flex justify-between items-center gap-4">
                        <div className="hidden lg:block">
                            <MiniCalendar date={prevMonth} startOfWeek={startOfWeek} />
                        </div>
                        <div className="text-center p-4 sm:p-6 rounded-xl shadow-lg bg-gradient-to-r from-sky-500 to-indigo-600 text-white select-none flex-grow">
                            <h1 className="text-2xl sm:text-3xl font-bold">스마트 스쿨 캘린더</h1>
                            <p className="text-sm sm:text-base mt-1">{schoolName ? schoolName + " " : ""}학사 일정 관리 시스템</p>
                        </div>
                        <div className="hidden lg:block">
                            <MiniCalendar date={nextMonth} startOfWeek={startOfWeek} />
                        </div>
                     </div>

                    <div className="p-2 border-t border-slate-200 flex items-center justify-between flex-wrap gap-2">
                         <div className="flex items-center gap-2 sm:gap-4">
                            {schoolLogo ? (
                                <img src={schoolLogo} alt="School Logo" className="h-8 sm:h-10 object-contain" />
                            ) : (
                                <span className="font-bold text-xl text-slate-700">🏫</span>
                            )}
                            <button onClick={goToToday} className={buttonBaseClasses}>
                                오늘
                            </button>
                        </div>
                        
                        <div className="flex items-center absolute left-1/2 -translate-x-1/2">
                            <button onClick={goToPreviousMonth} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                                <ChevronLeftIcon />
                            </button>
                            <h2 className="text-lg font-semibold text-slate-800 w-32 text-center">
                                {`${currentYear}년 ${currentMonth + 1}월`}
                            </h2>
                            <button onClick={goToNextMonth} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                                <ChevronRightIcon />
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            <select value={startOfWeek} onChange={(e) => setStartOfWeek(Number(e.target.value))} className={selectBaseClasses}>
                                <option value={0}>일요일 시작</option>
                                <option value={1}>월요일 시작</option>
                            </select>
                            <button 
                                onClick={onShowDataModal}
                                className="px-3 py-2 border border-gray-300 bg-blue-50 text-blue-700 text-sm font-medium rounded-md shadow-sm hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                데이터 설정
                            </button>
                            <button 
                                onClick={onReset}
                                className="px-3 py-2 border border-gray-300 bg-red-50 text-red-700 text-sm font-medium rounded-md shadow-sm hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                            >
                                데이터 초기화
                            </button>
                        </div>
                    </div>
                </header>
            );
        };
        // --- END: components/Header.tsx ---

        // --- START: components/Calendar.tsx ---
        const DayCell = ({ date, dayData, isToday, isCurrentMonth, reservedHeight, onClick }) => {
            const dayNumber = date.getDate();
            const dayOfWeek = date.getDay();

            const dayNumberColor = dayData?.holiday ? 'text-red-500' :
                dayOfWeek === 0 ? 'text-red-500' :
                dayOfWeek === 6 ? 'text-blue-500' :
                isCurrentMonth ? 'text-slate-700' : 'text-slate-400';

            const singleDayEvents = dayData?.events || [];
            // [변경] 숨김 처리된 이벤트(멀티데이의 일부)는 셀 내부 렌더링에서 제외
            const visibleEvents = singleDayEvents.filter(e => !e.isHidden);

            const displayableItems = [];
            
            const MAX_ITEMS_IN_CELL = 3;
            let remainingSlots = MAX_ITEMS_IN_CELL;
            
            if (dayData?.holiday) {
                displayableItems.push({ type: 'holiday', content: dayData.holiday });
                remainingSlots--;
            }
            
            visibleEvents.forEach(event => {
                if (remainingSlots > 0) {
                    displayableItems.push({ type: 'event', content: event });
                    remainingSlots--;
                }
            });
            
            const totalItems = (dayData?.holiday ? 1 : 0) + visibleEvents.length;
            const displayedCount = displayableItems.length;
            const moreItemsCount = totalItems - displayedCount;
            const hasMoreItems = moreItemsCount > 0;

            const isUserModified = dayData?.isUserModified;

            return (
                <div
                    className={`border-b border-r border-slate-300 flex flex-col relative transition-all duration-200 cursor-pointer ${isCurrentMonth ? 'bg-gradient-to-br from-white to-slate-50' : 'bg-gradient-to-br from-slate-50/80 to-slate-100/60'} hover:shadow-md hover:border-blue-300 group`}
                    style={{
                        boxShadow: isCurrentMonth 
                            ? 'inset 1px 1px 0 rgba(255,255,255,0.9), inset -1px -1px 0 rgba(0,0,0,0.05), 0 3px 8px rgba(59,130,246,0.12)' 
                            : 'inset 1px 1px 0 rgba(255,255,255,0.6), inset -1px -1px 0 rgba(0,0,0,0.02), 0 2px 4px rgba(0,0,0,0.05)',
                    }}
                    onClick={() => onClick(dayData || { date, events: [], holiday: null, teacherDuty: null, isUserModified: false })}
                >
                    <div className="flex-shrink-0 p-1 text-center relative">
                        <div className={`text-sm font-bold mx-auto transition-all duration-150 ${dayNumberColor} ${isToday ? 'bg-gradient-to-b from-blue-500 to-blue-700 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-lg shadow-blue-400/40' : 'w-7 h-7 flex items-center justify-center'}`}
                             style={!isToday && isCurrentMonth ? {
                                textShadow: '0 1px 2px rgba(0,0,0,0.1)',
                                fontWeight: '600'
                             } : {}}>
                            {dayNumber}
                        </div>
                        {isUserModified && (
                            <div className="absolute top-1 right-1 text-[10px]" title="사용자 수정됨">
                                ✏️
                            </div>
                        )}
                    </div>
                    <div className="flex-grow overflow-y-auto px-1 pb-1 space-y-1">
                        <div style={{ height: reservedHeight }} aria-hidden="true" /> 
                         {displayableItems.map((item, index) => {
                            if (item.type === 'holiday') {
                                return (
                                     <div key={`item-${index}`} className="text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis bg-gradient-to-b from-red-100 to-red-50 text-red-700 font-medium shadow-sm border border-red-200/50"
                                          style={{boxShadow: '0 2px 4px rgba(239,68,68,0.15), inset 0 1px 0 rgba(255,255,255,0.8)'}}>
                                        {item.content.name}
                                    </div>
                                )
                            }
                            if (item.type === 'event') {
                                const event = item.content;
                                return (
                                    <div key={`item-${index}`} className={`text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis ${event.color} font-medium shadow-sm border border-opacity-30 ${isUserModified ? 'ring-1 ring-blue-300 ring-offset-0' : ''}`}
                                         style={{boxShadow: '0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6)'}}>
                                        {event.title}
                                    </div>
                                )
                            }
                            return null;
                        })}
                        {hasMoreItems && (
                            <div className="text-xs text-slate-500 font-medium px-1.5 py-0.5">
                                + {moreItemsCount} more
                            </div>
                        )}
                    </div>
                    {dayData?.teacherDuty && (
                        <div className="flex-shrink-0 p-1 text-center text-xs font-medium text-slate-600 truncate border-t border-slate-200 mt-1 bg-gradient-to-r from-slate-50/50 to-slate-50"
                             style={{boxShadow: 'inset 0 1px 0 rgba(255,255,255,0.8)'}}>
                            {dayData.teacherDuty.teacher}
                        </div>
                    )}
                </div>
            );
        };

        const Calendar = ({ viewDate, startOfWeek: startOfWeekProp, calendarData, onDayClick }) => {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);

            const startDate = new Date(firstDayOfMonth);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const diff = (startDayOfWeek - startOfWeekProp + 7) % 7;
            startDate.setDate(startDate.getDate() - diff);

            const endDate = new Date(lastDayOfMonth);
            const endDayOfWeek = lastDayOfMonth.getDay();
            const endDiff = (6 - (endDayOfWeek - startOfWeekProp + 7) % 7);
            endDate.setDate(endDate.getDate() + endDiff);

            const weeks = [];
            let currentWeek = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                currentWeek.push(new Date(currentDate));
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
             if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }

            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            if (startOfWeekProp === 1) {
                dayHeaders.push(dayHeaders.shift());
            }

            const today = new Date();
            const todayKey = formatDateKey(today);

            const getWeekMultiDayEvents = (week) => {
                if (!calendarData) return [];
                const weekStart = week[0];
                const weekEnd = week[6];
                weekEnd.setHours(23,59,59,999); 
                return calendarData.multiDayEvents.filter(event => 
                    event.start <= weekEnd && event.end >= weekStart
                );
            }

            const dayHeaderTopAreaHeight = '1.8rem';
            const multiDayEventHeight = '1.4rem';

            return (
                <div className="border-t border-l border-slate-300 bg-white flex flex-col flex-grow shadow-lg rounded-xl overflow-hidden">
                    <div className="grid grid-cols-7">
                        {dayHeaders.map((day, index) => (
                            <div key={index} className={`bg-blue-600 text-white text-center py-2 text-sm font-semibold border-r border-b border-blue-700`}>
                                {day}
                            </div>
                        ))}
                    </div>
                    <div className="flex-grow grid grid-rows-auto">
                        {weeks.map((week, weekIndex) => {
                            const multiDayEventsInWeek = getWeekMultiDayEvents(week);
                            const maxLanes = multiDayEventsInWeek.length > 0 ? Math.max(...multiDayEventsInWeek.map(e => e.lane)) + 1 : 0;
                            const reservedHeight = `calc(${maxLanes} * ${multiDayEventHeight})`;

                            return (
                                <div key={weekIndex} className="grid grid-cols-7 relative border-b border-slate-300" 
                                     style={{ minHeight: '120px' }}>
                                    {multiDayEventsInWeek.map(event => {
                                        const weekStart = new Date(week[0]);
                                        weekStart.setHours(0,0,0,0);

                                        const eventStart = new Date(event.start);
                                        eventStart.setHours(0,0,0,0);
                                        
                                        const eventEnd = new Date(event.end);
                                        eventEnd.setHours(0,0,0,0);

                                        const startDayIndex = Math.max(0, Math.round((eventStart.getTime() - weekStart.getTime()) / (1000 * 3600 * 24)));
                                        const endDayIndex = Math.min(6, Math.round((eventEnd.getTime() - weekStart.getTime()) / (1000 * 3600 * 24)));
                                        
                                        const startCol = startDayIndex;
                                        const span = endDayIndex - startDayIndex + 1;
                                        
                                        if (span <= 0) return null;

                                        return (
                                            <div 
                                                key={event.id}
                                                // [변경] pointer-events-none 추가: 클릭이 아래쪽 DayCell로 통과되도록 함
                                                className={`absolute text-xs p-1 rounded overflow-hidden text-ellipsis whitespace-nowrap ${event.color} font-semibold shadow-md pointer-events-none`}
                                                style={{ 
                                                    top: `calc(${dayHeaderTopAreaHeight} + ${event.lane} * ${multiDayEventHeight})`, 
                                                    left: `calc(${(100 / 7) * startCol}% + 2px)`,
                                                    width: `calc(${(100 / 7) * span}% - 4px)`,
                                                    height: `calc(${multiDayEventHeight} - 2px)`,
                                                    zIndex: 5
                                                }}
                                            >
                                                {event.title}
                                            </div>
                                        )
                                    })}

                                    {week.map((date) => {
                                        const dateKey = formatDateKey(date);
                                        const dayData = calendarData?.dayDataMap.get(dateKey);
                                        return (
                                            <DayCell
                                                key={dateKey}
                                                date={date}
                                                dayData={dayData}
                                                isToday={dateKey === todayKey}
                                                isCurrentMonth={date.getMonth() === month}
                                                reservedHeight={reservedHeight}
                                                onClick={onDayClick}
                                            />
                                        );
                                    })}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        // --- END: components/Calendar.tsx ---

        // --- START: App.tsx ---

        // --- LocalStorage 관리 ---
        const StorageManager = {
            saveEvents: (csv) => localStorage.setItem('schoolEvents', csv),
            saveHolidays: (csv) => localStorage.setItem('schoolHolidays', csv),
            saveSpecialEvents: (csv) => localStorage.setItem('schoolSpecialEvents', csv),
            saveSchoolName: (name) => localStorage.setItem('schoolName', name),
            saveLogo: (logoData) => localStorage.setItem('schoolLogo', logoData),
            removeLogo: () => localStorage.removeItem('schoolLogo'),
            
            // 사용자 수정 이벤트 관리
            saveUserModifiedEvents: (events) => localStorage.setItem('userModifiedEvents', JSON.stringify(events)),
            getUserModifiedEvents: () => {
                const data = localStorage.getItem('userModifiedEvents');
                return data ? JSON.parse(data) : {};
            },
            clearUserModifiedEvents: () => localStorage.removeItem('userModifiedEvents'),

            // [신규] 사용자 수정 특별행사(Duty) 관리
            saveUserModifiedDuties: (duties) => localStorage.setItem('userModifiedDuties', JSON.stringify(duties)),
            getUserModifiedDuties: () => {
                const data = localStorage.getItem('userModifiedDuties');
                return data ? JSON.parse(data) : {};
            },
            clearUserModifiedDuties: () => localStorage.removeItem('userModifiedDuties'),
            
            getEvents: () => localStorage.getItem('schoolEvents'),
            getHolidays: () => localStorage.getItem('schoolHolidays'),
            getSpecialEvents: () => localStorage.getItem('schoolSpecialEvents'),
            getSchoolName: () => localStorage.getItem('schoolName'),
            getLogo: () => localStorage.getItem('schoolLogo'),
            
            hasData: () => localStorage.getItem('schoolName') !== null,
            clearData: () => {
                localStorage.removeItem('schoolEvents');
                localStorage.removeItem('schoolHolidays');
                localStorage.removeItem('schoolSpecialEvents');
                localStorage.removeItem('schoolName');
                localStorage.removeItem('schoolLogo');
                localStorage.removeItem('userModifiedEvents');
                localStorage.removeItem('userModifiedDuties');
            }
        };

        const DataUploadModal = ({ onDataLoaded, onClose }) => {
            const [schoolName, setSchoolName] = useState(StorageManager.getSchoolName() || '');
            const [events, setEvents] = useState(null);
            const [holidays, setHolidays] = useState(null);
            const [specialEvents, setSpecialEvents] = useState(null);
            const [logo, setLogo] = useState(StorageManager.getLogo());
            const [uploadedFiles, setUploadedFiles] = useState({
                events: false,
                holidays: false,
                specialEvents: false,
                logo: false
            });
            const [error, setError] = useState('');
            
            const handleFileChange = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                setError(''); 

                if (type === 'logo') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setLogo(event.target.result);
                        setUploadedFiles(prev => ({...prev, logo: true}));
                    };
                    reader.onerror = () => setError("로고 파일을 읽는 중 오류가 발생했습니다.");
                    reader.readAsDataURL(file);
                    return;
                } 
                
                const fileName = file.name.toLowerCase();
                const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                
                const callback = (csvText) => {
                    if (type === 'events') {
                        setEvents(csvText);
                    } else if (type === 'holidays') {
                        setHolidays(csvText);
                    } else if (type === 'specialEvents') {
                        setSpecialEvents(csvText);
                    }
                    setUploadedFiles(prev => ({...prev, [type]: true}));
                    setError('');
                };
                
                const onError = (message) => {
                    setError(message);
                    setUploadedFiles(prev => ({...prev, [type]: false}));
                };

                if (isExcel) {
                    processExcelFile(file, callback, onError);
                } else {
                    processCsvFile(file, callback, onError);
                }
            };

            const handleRemoveLogo = () => {
                setLogo(null);
                setUploadedFiles(prev => ({...prev, logo: false}));
                StorageManager.removeLogo();
            };

            const handleSubmit = () => {
                if (!schoolName.trim()) {
                    setError('학교명을 입력해주세요.');
                    return;
                }
                
                StorageManager.saveSchoolName(schoolName);
                if (events) StorageManager.saveEvents(events);
                if (holidays) StorageManager.saveHolidays(holidays);
                if (specialEvents) StorageManager.saveSpecialEvents(specialEvents);
                if (logo) StorageManager.saveLogo(logo);
                
                onDataLoaded({
                    schoolName: schoolName,
                    events: events || StorageManager.getEvents(),
                    holidays: holidays || StorageManager.getHolidays(),
                    specialEvents: specialEvents || StorageManager.getSpecialEvents(),
                    logo: logo
                });
            };


            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
                        <h1 className="text-3xl font-bold text-slate-800 mb-6">데이터 설정</h1>
                        <div className="space-y-6">
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">학교 정보</h2>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        학교명 * <span className="text-xs text-slate-500">(필수)</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        placeholder="예: 원묵고등학교"
                                        value={schoolName}
                                        onChange={(e) => setSchoolName(e.target.value)}
                                        maxLength={50}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        학교 로고 <span className="text-xs text-slate-500">(선택, PNG/JPG 파일)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, 'logo')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.logo && <span className="text-green-600 font-semibold">✓ 변경됨</span>}
                                    </div>
                                    {logo && (
                                        <div className="mt-3 flex items-center gap-3">
                                            <img src={logo} alt="School Logo" className="h-20 object-contain" />
                                            <button onClick={handleRemoveLogo} className="px-3 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 transition-colors text-sm">삭제</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">학사일정 데이터 업로드</h2>
                                <p className="text-xs text-slate-500 mb-4">파일 형식: CSV 또는 XLSX (첫 번째 시트만 사용). 기존 데이터를 덮어씁니다.</p>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        학사일정 파일 <span className="text-xs text-slate-500">(날짜, 행사1, 행사2... 형식)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'events')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.events && <span className="text-green-600 font-semibold">✓</span>}
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        공휴일 파일 <span className="text-xs text-slate-500">(날짜, 공휴일명 형식)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'holidays')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.holidays && <span className="text-green-600 font-semibold">✓</span>}
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        특별 행사 파일 <span className="text-xs text-slate-500">(날짜, 요일, 행사명/지도교사 형식)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'specialEvents')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.specialEvents && <span className="text-green-600 font-semibold">✓</span>}
                                    </div>
                                </div>
                            </div>
                            {error && <div className="p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm">{error}</div>}
                            <div className="flex gap-3 pt-4">
                                <button onClick={handleSubmit} className="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">저장하고 닫기</button>
                                <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-400 transition-colors">
                                    취소
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [rawEventsData, setRawEventsData] = useState('');
            const [rawHolidaysData, setRawHolidaysData] = useState('');
            const [rawDutiesData, setRawDutiesData] = useState('');
            const [schoolLogo, setSchoolLogo] = useState(null);
            const [showDataModal, setShowDataModal] = useState(false);
            const [viewDate, setViewDate] = useState(new Date());
            const [startOfWeek, setStartOfWeek] = useState(0);
            const [selectedDay, setSelectedDay] = useState(null);
            const [schoolName, setSchoolName] = useState('');
            const [userModifiedEvents, setUserModifiedEvents] = useState({});
            const [userModifiedDuties, setUserModifiedDuties] = useState({}); // [신규] 특별 행사 수정 상태
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            useEffect(() => {
                const savedSchoolName = StorageManager.getSchoolName();

                if (savedSchoolName) {
                    setSchoolName(savedSchoolName);
                    setSchoolLogo(StorageManager.getLogo() || DEFAULT_LOGO_DATA_URL);
                    setRawEventsData(StorageManager.getEvents() || '');
                    setRawHolidaysData(StorageManager.getHolidays() || '');
                    setRawDutiesData(StorageManager.getSpecialEvents() || '');
                    setUserModifiedEvents(StorageManager.getUserModifiedEvents());
                    setUserModifiedDuties(StorageManager.getUserModifiedDuties());
                    setShowDataModal(false);
                } else {
                    StorageManager.saveSchoolName(DEFAULT_SCHOOL_NAME);
                    StorageManager.saveLogo(DEFAULT_LOGO_DATA_URL);
                    StorageManager.saveEvents(rawEventsCsv);
                    StorageManager.saveHolidays(rawHolidaysCsv);
                    StorageManager.saveSpecialEvents(rawDutiesCsv);

                    setSchoolName(DEFAULT_SCHOOL_NAME);
                    setSchoolLogo(DEFAULT_LOGO_DATA_URL);
                    setRawEventsData(rawEventsCsv);
                    setRawHolidaysData(rawHolidaysCsv);
                    setRawDutiesData(rawDutiesCsv);
                    
                    setShowDataModal(false); 
                }
            }, []);

            const rawEvents = useMemo(() => parseEventsCsv(rawEventsData), [rawEventsData]);
            const holidays = useMemo(() => parseHolidaysCsv(rawHolidaysData), [rawHolidaysData]);
            const duties = useMemo(() => parseTeachersCsv(rawDutiesData), [rawDutiesData]); 

            const calendarData = useMemo(() => {
                // userModifiedDuties 추가 전달
                return processCalendarData(rawEvents, holidays, duties, userModifiedEvents, userModifiedDuties);
            }, [rawEvents, holidays, duties, userModifiedEvents, userModifiedDuties]);


            const handleDataLoaded = (data) => {
                setSchoolName(data.schoolName);
                setRawEventsData(data.events);
                setRawHolidaysData(data.holidays);
                setRawDutiesData(data.specialEvents);
                if (data.logo) {
                    setSchoolLogo(data.logo);
                }
                setShowDataModal(false);
            };

            const handleReset = () => {
                StorageManager.clearData();
                
                StorageManager.saveSchoolName(DEFAULT_SCHOOL_NAME);
                StorageManager.saveLogo(DEFAULT_LOGO_DATA_URL);
                StorageManager.saveEvents(rawEventsCsv);
                StorageManager.saveHolidays(rawHolidaysCsv);
                StorageManager.saveSpecialEvents(rawDutiesCsv);
                
                setSchoolName(DEFAULT_SCHOOL_NAME);
                setSchoolLogo(DEFAULT_LOGO_DATA_URL);
                setRawEventsData(rawEventsCsv);
                setRawHolidaysData(rawHolidaysCsv);
                setRawDutiesData(rawDutiesCsv);
                setUserModifiedEvents({});
                setUserModifiedDuties({});
                
                setShowDataModal(false);
                setShowResetConfirm(false);
            };

            const handleSaveUserEvents = useCallback((dateKey, events, duty) => {
                // 1. 이벤트 목록 저장
                setUserModifiedEvents(prev => {
                    const newEvents = { ...prev };
                    newEvents[dateKey] = events;
                    StorageManager.saveUserModifiedEvents(newEvents);
                    return newEvents;
                });

                // 2. 특별 행사(Duty) 저장
                setUserModifiedDuties(prev => {
                    const newDuties = { ...prev };
                    newDuties[dateKey] = duty;
                    StorageManager.saveUserModifiedDuties(newDuties);
                    return newDuties;
                });
            }, []);

            const handleResetDate = useCallback((dateKey) => {
                // 1. 이벤트 복구
                setUserModifiedEvents(prev => {
                    const newEvents = { ...prev };
                    delete newEvents[dateKey];
                    StorageManager.saveUserModifiedEvents(newEvents);
                    return newEvents;
                });

                // 2. 특별 행사 복구
                setUserModifiedDuties(prev => {
                    const newDuties = { ...prev };
                    delete newDuties[dateKey];
                    StorageManager.saveUserModifiedDuties(newDuties);
                    return newDuties;
                });
            }, []);


            const handleDayClick = useCallback((dayData) => {
                setSelectedDay(dayData);
            }, []);

            return (
                <div className="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl flex flex-col min-h-[85vh] overflow-hidden">
                     <Header
                        viewDate={viewDate}
                        setViewDate={setViewDate}
                        startOfWeek={startOfWeek}
                        setStartOfWeek={setStartOfWeek}
                        onReset={() => setShowResetConfirm(true)}
                        onShowDataModal={() => setShowDataModal(true)}
                        schoolName={schoolName}
                        schoolLogo={schoolLogo}
                    />
                    <main className="flex-grow p-1 sm:p-2 lg:p-4"> 
                        <Calendar
                            viewDate={viewDate}
                            startOfWeek={startOfWeek}
                            calendarData={calendarData}
                            onDayClick={handleDayClick}
                        />
                    </main>
                    <footer className="p-2 text-center text-xs text-slate-500 border-t border-slate-200">
                        © 2026 KH KIM. All Rights Reserved.
                    </footer>
                    {selectedDay && (
                        <EventModal 
                            dayData={selectedDay} 
                            onClose={() => setSelectedDay(null)} 
                            onSaveUserEvents={handleSaveUserEvents}
                            onResetDate={handleResetDate}
                            userModifiedEvents={userModifiedEvents}
                        />
                    )}
                    {showDataModal && (
                        <DataUploadModal 
                            onDataLoaded={handleDataLoaded} 
                            onClose={() => setShowDataModal(false)} 
                        />
                    )}
                    <ConfirmModal
                        isOpen={showResetConfirm}
                        message={`정말로 모든 데이터를 초기화하시겠습니까?\n\n로고, 학교명, 학사일정 데이터, 사용자 추가 일정이 모두 삭제되고 기본 상태로 돌아갑니다.`}
                        onConfirm={handleReset}
                        onCancel={() => setShowResetConfirm(false)}
                        confirmText="전체 초기화"
                        isDanger={true}
                    />
                </div>
            );
        };
        // --- END: App.tsx ---

        // --- START: index.tsx (Mounting Logic) ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
          </React.StrictMode>
        );
        // --- END: index.tsx ---
    </script>
</body>
</html>

