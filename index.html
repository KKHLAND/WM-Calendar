<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™ì‚¬ì¼ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
      body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .grid-rows-auto { grid-auto-rows: minmax(100px, 1fr); }
    </style>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script>
      if (typeof tailwind !== 'undefined') { tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'Noto Sans KR', 'sans-serif'] } } } } }
      const processExcelFile = (file, cb, onErr) => {
          const r = new FileReader();
          r.onload = (e) => { try { const wb = XLSX.read(e.target.result, {type:'binary'}); cb(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]], {FS:',',RS:'\n'})); } catch(x) { onErr("ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜"); } };
          r.onerror = () => onErr("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜");
          const fn = file.name.toLowerCase();
          if (fn.endsWith('.xlsx')||fn.endsWith('.xls')) r.readAsBinaryString(file); else onErr("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹");
      };
      const processCsvFile = (file, cb, onErr) => {
          const r = new FileReader();
          r.onload = (e) => { try { let t=e.target.result; if(t.charCodeAt(0)===0xFEFF) t=t.slice(1); t=t.replace(/\r\n|\r/g,'\n'); cb(t); } catch(x) { onErr("CSV ì½ê¸° ì˜¤ë¥˜"); } };
          r.onerror = () => onErr("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜"); r.readAsText(file);
      };
    </script>
</head>
<body class="bg-gradient-to-br from-sky-200 to-blue-100 p-2 sm:p-4 lg:p-8 min-h-screen">
    <div id="root"></div>
    <script type="text/babel" data-presets="react">
        const { useState, useMemo, useCallback, useEffect } = React;

        // === Date utility functions ===
        const startOfMonth = (d) => { const r=new Date(d); r.setDate(1); r.setHours(0,0,0,0); return r; };
        const endOfMonth = (d) => { const r=new Date(d.getFullYear(),d.getMonth()+1,0); r.setHours(23,59,59,999); return r; };
        const dateFnsStartOfWeek = (d, o={}) => { const w=o.weekStartsOn||0; const r=new Date(d); const dy=r.getDay(); r.setDate(r.getDate()-((dy<w?7:0)+dy-w)); r.setHours(0,0,0,0); return r; };
        const endOfWeek = (d, o={}) => { const w=o.weekStartsOn||0; const r=new Date(d); const dy=r.getDay(); r.setDate(r.getDate()+((dy<w?-7:0)+6-(dy-w))); r.setHours(23,59,59,999); return r; };
        const eachDayOfInterval = ({start,end}) => { const days=[]; const c=new Date(start); c.setHours(0,0,0,0); const e=new Date(end); e.setHours(0,0,0,0); while(c<=e){days.push(new Date(c));c.setDate(c.getDate()+1);} return days; };
        const format = (d, f) => { const mn=['January','February','March','April','May','June','July','August','September','October','November','December']; if(f==='MMMM yyyy') return `${mn[d.getMonth()]} ${d.getFullYear()}`; if(f==='d') return String(d.getDate()); return d.toLocaleDateString(); };
        const isSameMonth = (a,b) => a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth();
        const isToday = (d) => { const t=new Date(); return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate(); };

        // === School Data ===
        const DEFAULT_SCHOOL_NAME = 'ì›ë¬µê³ ë“±í•™êµ';
        const DEFAULT_LOGO_DATA_URL = 'https://i.imgur.com/6ZCUaap.jpeg';

        const rawEventsCsv = `"ë‚ ì§œ","í–‰ì‚¬1","í–‰ì‚¬2","í–‰ì‚¬3"
"2026. 2. 11","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","í•™êµë¡œì°¾ì•„ì˜¤ëŠ” ì»¨ì„¤íŒ… AI ì—°ìˆ˜",""
"2026. 2. 12","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","í•™êµë¡œì°¾ì•„ì˜¤ëŠ” ì»¨ì„¤íŒ… AI ì—°ìˆ˜",""
"2026. 2. 13","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","ì‹ ì…ìƒ ì˜ˆë¹„ì†Œì§‘ ë° ì‚¬ì „ êµìœ¡(ì˜¤ì „)","ë¶€ì„œë³„ êµê³¼ë³„ ììœ¨ì—°ìˆ˜(ì˜¤í›„)"
"2026. 2. 19","ì…í•™ì „ ë°°ì • ë“±ë¡","",""
"2026. 3. 3","ê°œí•™ì‹(2,3)","ì…í•™ì‹(1)",""
"2026. 3. 4","ììœ¨(ìƒê²¬ë¡€/OT(1))","ìƒí™œì•ˆì „êµìœ¡(2,3)",""
"2026. 3. 6","ììœ¨","ì „êµì§ì›íšŒì˜1",""
"2026. 3. 13","ììœ¨","",""
"2026. 3. 20","ë™ì•„ë¦¬","",""
"2026. 3. 23","í•™ë¶€ëª¨ì´íšŒ","1í•™ê¸°ìˆ˜ì—…ê³µê°œì˜ë‚ (5,6êµì‹œ)",""
"2026. 3. 24","í•™ë ¥í‰ê°€(1,2,3)","",""
"2026. 3. 25","êµì›í•™ìŠµê³µë™ì²´1","",""
"2026. 3. 27","ììœ¨","",""
"2026. 3. 30","ì°½ì˜ìƒìƒ ì¸ë¬¸ ê¸°ì´ˆ1","",""
"2026. 4. 1","ë³´ê³ ì„œ ì‘ì„±ë²• íŠ¹ê°•","",""
"2026. 4. 3","ë´‰ì‚¬í™œë™ ì‚¬ì „êµìœ¡","ì „êµì§ì›íšŒì˜2",""
"2026. 4. 6","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ1","",""
"2026. 4. 8","ì´ê³µê³„ì „ë¬¸ê°€ ì´ˆì²­íŠ¹ê°•1","",""
"2026. 4. 9","í™”ìš”ì¼ ìˆ˜ì—…","",""
"2026. 4. 10","í•™ìƒíšŒì¥ ì„ ê±°","",""
"2026. 4. 17","ë™ì•„ë¦¬","",""
"2026. 4. 24","ì¤‘ê°„ê³ ì‚¬-êµê³¼í˜‘ì˜","",""
"2026. 4. 27","ì¤‘ê°„ê³ ì‚¬-ë¶€ì„œí˜‘ì˜","",""
"2026. 4. 28","ì¤‘ê°„ê³ ì‚¬-í•™ë…„í˜‘ì˜","",""
"2026. 4. 29","ì¤‘ê°„ê³ ì‚¬-êµì›í•™ìŠµê³µë™ì²´2","",""
"2026. 4. 30","ì¤‘ê°„ê³ ì‚¬","",""
"2026. 5. 6","í•™êµí˜„ì¥ì‹¤ìŠµ ì‹œì‘","ë¹„ê²½ìŸì‹ ë…ì„œ í† ë¡ ","STEAMì‹¤í—˜ë°˜1"
"2026. 5. 7","í•™ë ¥í‰ê°€(3)","",""
"2026. 5. 8","í•™ê¸‰ë³„ ë´‰ì‚¬í™œë™","ì°½ì˜ìƒìƒ ì¸ë¬¸ ê¸°ì´ˆ2","STEAMì‹¤í—˜ë°˜2"
"2026. 5. 9","ì°½ì˜ìƒìƒ ì—­ì‚¬ ë¬¸í™”ì²´í—˜","",""
"2026. 5. 11","STEAMì‹¤í—˜ë°˜3","",""
"2026. 5. 13","STEAMì‹¤í—˜ë°˜4","",""
"2026. 5. 15","ì²´ìœ¡í•œë§ˆë‹¹","ë¬¸í™”ì²´í—˜(3)",""
"2026. 5. 18","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ2","STEAMì‹¤í—˜ë°˜5",""
"2026. 5. 20","ë…ì„œë©˜í† ë§ ì „ì²´ í† ë¡ ì¼","",""
"2026. 5. 22","ë™ì•„ë¦¬","STEAMì‹¤í—˜ë°˜6",""
"2026. 5. 25","ëŒ€ì²´ê³µíœ´ì¼","",""
"2026. 5. 27","êµì›í•™ìŠµê³µë™ì²´3","",""
"2026. 5. 29","ììœ¨","",""
"2026. 6. 1","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ3","",""
"2026. 6. 4","í•™ë ¥í‰ê°€(1,2)","ëŒ€ìˆ˜ëŠ¥ ëª¨í‰(3)",""
"2026. 6. 5","ë™ì•„ë¦¬","",""
"2026. 6. 8","STEAMì‹¤í—˜ë°˜ ë°œí‘œíšŒ","",""
"2026. 6. 10","ì§€ë…í•œ ë…ì„œí´ëŸ½ ì „ì²´ í† ë¡ ì¼","",""
"2026. 6. 12","ììœ¨","ì „êµì§ì›íšŒì˜3",""
"2026. 6. 19","ë™ì•„ë¦¬","",""
"2026. 6. 26","ììœ¨","",""
"2026. 6. 30","ê¸°ë§ê³ ì‚¬","",""
"2026. 7. 1","ê¸°ë§ê³ ì‚¬-êµê³¼í˜‘ì˜","",""
"2026. 7. 2","ê¸°ë§ê³ ì‚¬-ë¶€ì„œí˜‘ì˜","",""
"2026. 7. 3","ê¸°ë§ê³ ì‚¬-í•™ë…„í˜‘ì˜","",""
"2026. 7. 6","ê¸°ë§ê³ ì‚¬","êµì›í•™ìŠµê³µë™ì²´4",""
"2026. 7. 7","ì„ íƒê³¼ëª©ì„¤ëª…íšŒ","",""
"2026. 7. 8","í•™ë ¥í‰ê°€(3)","",""
"2026. 7. 10","ììœ¨","ìµœì„±ë³´ ì •ì„œì  ì§€ì› êµìœ¡(ì½˜ì„œíŠ¸)","ê²½ì œí•™ íŠ¹ê°•"
"2026. 7. 13","ìµœì„±ë³´ ì •ì„œì  ì§€ì› êµìœ¡(íŠ¹ê°•)","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ4",""
"2026. 7. 15","ê²½ì œí•™ íŠ¹ê°•","",""
"2026. 7. 16","ìµœì„±ë³´ ë³´ì¶©ì§€ë„ OT","",""
"2026. 7. 20","ì˜ˆìˆ êµìœ¡ë°œí‘œíšŒ","ì „êµì§ì›íšŒì˜4","ë°©í•™ì‹"
"2026. 7. 21","ê³¼í•™ì‹¤í—˜ìº í”„","",""
"2026. 7. 22","4ì°¨ì‚°ì—…ê³µí•™ìº í”„","",""
"2026. 8. 13","<ê°œí•™>","",""
"2026. 8. 14","ë™ì•„ë¦¬","ì „êµì§ì›íšŒì˜5",""
"2026. 8. 19","ê³¼í•™í† ë¡ ë§ˆë‹¹","ë…¼ì œë°œí‘œì¼",""
"2026. 8. 21","ë™ì•„ë¦¬","",""
"2026. 8. 24","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ5","",""
"2026. 8. 26","ê³¼í•™í† ë¡ ë§ˆë‹¹","ì°¸ê°€ ì‹ ì²­ ë§ˆê°ì¼","êµì›í•™ìŠµê³µë™ì²´5"
"2026. 8. 27","ê¸ˆìš”ì¼ ìˆ˜ì—…","(ë™3)",""
"2026. 8. 28","ë¬µí–¥ì œ","",""
"2026. 9. 2","í•™ë ¥í‰ê°€(1,2)","ëŒ€ìˆ˜ëŠ¥ ëª¨í‰(3)",""
"2026. 9. 4","êµìœ¡ê³¼ì •ë°•ëŒíšŒ","ê³¼í•™í† ë¡ ë§ˆë‹¹","ê°œìš”ì„œì œì¶œ(ì˜ˆì„ )"
"2026. 9. 9","ë…ì„œë©˜í† ë§ ì „ì²´ í† ë¡ ì¼","",""
"2026. 9. 11","í•™ê¸‰ë³„ ë´‰ì‚¬í™œë™","",""
"2026. 9. 16","ê³¼í•™í† ë¡ ë§ˆë‹¹(ë³¸ì„ )","",""
"2026. 9. 18","ììœ¨","ì „êµì§ì›íšŒì˜6",""
"2026. 9. 22","ëª©ìš”ì¼ ìˆ˜ì—…","",""
"2026. 9. 23","ê³¼í•™í† ë¡ ë§ˆë‹¹(ê²°ì„ )","",""
"2026. 10. 1","ì¤‘ê°„ê³ ì‚¬-êµê³¼í˜‘ì˜","",""
"2026. 10. 2","ì¤‘ê°„ê³ ì‚¬-ë¶€ì„œí˜‘ì˜","",""
"2026. 10. 6","ì¤‘ê°„ê³ ì‚¬-í•™ë…„í˜‘ì˜","",""
"2026. 10. 7","ì¤‘ê°„ê³ ì‚¬","êµì›í•™ìŠµê³µë™ì²´6",""
"2026. 10. 8","ì¤‘ê°„ê³ ì‚¬","",""
"2026. 10. 14","ìˆ˜ë ¨íšŒ(1)","ì¼ì¼í˜• ì²´í—˜í™œë™(2)",""
"2026. 10. 15","ìˆ˜ë ¨íšŒ(1)","ì¼ì¼í˜• ì²´í—˜í™œë™(2)",""
"2026. 10. 16","ìˆ˜ë ¨íšŒ(1)","ì¼ì¼í˜• ì²´í—˜í™œë™(2)","ììœ¨(3)"
"2026. 10. 20","í•™ë ¥í‰ê°€(1,2,3)","",""
"2026. 10. 21","ì§€ë…í•œ ë…ì„œí´ëŸ½ í† ë¡ ì¼","",""
"2026. 10. 23","ë™ì•„ë¦¬","ë…ë„ì˜ ë‚  í–‰ì‚¬",""
"2026. 10. 24","ìˆ˜í•™ì°½ì˜ë ¥ìº í”„","",""
"2026. 10. 26","ì¸ë¬¸íƒêµ¬ ë°œí‘œ","ìˆ˜ì •ì›ê³  ë§ˆê°",""
"2026. 10. 28","ì´ê³µê³„ì „ë¬¸ê°€","ì´ˆì²­íŠ¹ê°•2",""
"2026. 10. 30","ììœ¨","",""
"2026. 11. 2","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì •ê·œ6","(ì¸ë¬¸íƒêµ¬ ë°œí‘œ)",""
"2026. 11. 6","ììœ¨","ìœµí•© ë…ì„œìº í”„",""
"2026. 11. 7","ì²œë¬¸ìš°ì£¼ìº í”„","",""
"2026. 11. 9","ì°½ì˜ìƒìƒ ì¸ë¬¸ ì˜ˆë¹„ì¼","(ì¸ë¬¸íƒêµ¬ ë°œí‘œ)",""
"2026. 11. 13","ììœ¨","",""
"2026. 11. 19","ëŒ€í•™ìˆ˜í•™ëŠ¥ë ¥ì‹œí—˜(3)","íœ´ì—…ì¼(1,2)",""
"2026. 11. 20","ì¬ëŸ‰íœ´ì—…ì¼","",""
"2026. 11. 23","ê¸ˆìš”ì¼ ìˆ˜ì—…","",""
"2026. 11. 24"," ê¸°ë§ê³ ì‚¬(3í•™ë…„)","",""
"2026. 11. 25","ê¸°ë§ê³ ì‚¬(3í•™ë…„)","êµì›í•™ìŠµê³µë™ì²´7",""
"2026. 11. 26","ê¸°ë§ê³ ì‚¬(3í•™ë…„)","",""
"2026. 11. 27","ê¸°ë§ê³ ì‚¬(3í•™ë…„)","ììœ¨","ì „êµì§ì›íšŒì˜7"
"2026. 12. 1","ëª©ìš”ì¼ ìˆ˜ì—…","",""
"2026. 12. 4","ììœ¨","",""
"2026. 12. 10","ê¸°ë§ê³ ì‚¬(1,2)","êµê³¼í˜‘ì˜íšŒ",""
"2026. 12. 11","ììœ¨(3)","ê¸°ë§ê³ ì‚¬(1,2)","ë¶€ì„œí˜‘ì˜íšŒ"
"2026. 12. 14","ê¸°ë§ê³ ì‚¬(1,2)","í•™ë…„í˜‘ì˜íšŒ",""
"2026. 12. 15","ê¸°ë§ê³ ì‚¬(1,2)","",""
"2026. 12. 16","ê¸°ë§ê³ ì‚¬(1,2)","",""
"2026. 12. 18","*ìµœì„±ë³´ ì •ì„œì  ì§€ì› êµìœ¡(ê³¨ë“ ë²¨)","",""
"2026. 12. 23","*ìµœì„±ë³´ ì •ì„œì  ì§€ì› êµìœ¡(ì½˜ì„œíŠ¸)","êµì›í•™ìŠµê³µë™ì²´ 8",""
"2026. 12. 24","ì™¸êµ­ì–´ ë…¸ë˜ì œ","",""
"2026. 12. 28","*ìµœì„±ë³´ ë³´ì¶©ì§€ë„ OT","ë¼ìë‘",""
"2026. 12. 29","ì˜ˆìˆ êµìœ¡ë°œí‘œíšŒ","",""
"2026. 12. 30","ì „êµì§ì›íšŒì˜8","(3í•™ë…„ ì¡¸ì—…ì‚¬ì •ì•ˆ)","<ë°©í•™ì‹>"
"2027. 2. 1","<ê°œí•™>","",""
"2027. 2. 3","ì¡¸ì—…ì‹(3)","",""
"2027. 2. 4","<ì¢…ì—…ì‹(1,2)>","",""
"2027. 2. 17","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","",""
"2027. 2. 18","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","",""
"2027. 2. 19","ì‹ í•™ë…„ëŒ€ë¹„ì§‘ì¤‘ì—°ìˆ˜","ë¶€ì¥ê¸°íšì›Œí¬ìˆ",""
`;

        const rawHolidaysCsv = `"ë‚ ì§œ","íœ´ì¼"
"2026-01-01","ì‹ ì •(ì–‘ë ¥ì„¤)"
"2026-02-16","ì„¤ë‚  ì—°íœ´"
"2026-02-17","ì„¤ë‚ "
"2026-02-18","ì„¤ë‚  ì—°íœ´"
"2026-03-01","3Â·1ì ˆ"
"2026-03-02","ëŒ€ì²´ê³µíœ´ì¼(3Â·1ì ˆ)"
"2026-05-05","ì–´ë¦°ì´ë‚ "
"2026-05-01","ì¬ëŸ‰íœ´ì—…ì¼"
"2026-05-04","ì¬ëŸ‰íœ´ì—…ì¼"
"2026-05-24","ë¶€ì²˜ë‹˜ ì˜¤ì‹ ë‚ "
"2026-05-25","ëŒ€ì²´ê³µíœ´ì¼(ë¶€ì²˜ë‹˜ ì˜¤ì‹ ë‚ )"
"2026-06-03","ì§€ë°©ì„ ê±°ì¼"
"2026-06-06","í˜„ì¶©ì¼"
"2026-07-17","ì œí—Œì ˆ"
"2026-08-15","ê´‘ë³µì ˆ"
"2026-08-17","ëŒ€ì²´ê³µíœ´ì¼(ê´‘ë³µì ˆ)"
"2026-09-24","ì¶”ì„ ì—°íœ´"
"2026-09-25","ì¶”ì„"
"2026-09-26","ì¶”ì„ ì—°íœ´"
"2026-10-03","ê°œì²œì ˆ"
"2026-10-05","ëŒ€ì²´ê³µíœ´ì¼(ê°œì²œì ˆ)"
"2026-10-09","í•œê¸€ë‚ "
"2026-12-25","í¬ë¦¬ìŠ¤ë§ˆìŠ¤"
"2027-01-01","ì‹ ì •(ì–‘ë ¥ì„¤)"
"2027-02-06","ì„¤ë‚  ì—°íœ´"
"2027-02-07","ì„¤ë‚ "
"2027-02-08","ì„¤ë‚  ì—°íœ´"
"2027-02-09","ëŒ€ì²´ê³µíœ´ì¼(ì„¤ë‚ )"
`;

        const rawDutiesCsv = `"ë‚ ì§œ","ìš”ì¼","ì§€ë„êµì‚¬","ì¢…ë¥˜","ë¹„ê³ "
"2026. 3. 2","ì›”","ì‹ ë¯¸ë˜","íœ´ì¼ê·¼ë¬´","ëŒ€ì²´ê³µíœ´ì¼(3Â·1ì ˆ)"
"2026. 3. 3","í™”","ê¹€í™”ì„­","",""

`;

        // === Data Processing ===
        const parseDate = (s) => {
            if(!s) return null;
            let c=s.replace(/\./g,'-').replace(/\s/g,''); let p=c.split('-').filter(x=>x);
            if(p.length===3){const[y,m,d]=p.map(x=>parseInt(x,10));if(!isNaN(y)&&y>1900&&m>=1&&m<=12&&d>=1&&d<=31)return new Date(y,m-1,d);}
            c=s.replace(/\./g,'/').replace(/\s/g,'');p=c.split('/');
            if(p.length===3){const[m,d,y]=p.map(x=>parseInt(x,10));if(!isNaN(y)&&y>1900&&m>=1&&m<=12&&d>=1&&d<=31)return new Date(y,m-1,d);}
            const dt=new Date(s); if(dt instanceof Date&&!isNaN(dt))return dt; return null;
        };
        const formatDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const parseCsvLine = (line) => {
            const fields=[]; let cur='',inQ=false;
            for(const ch of line){if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){fields.push(cur.trim());cur='';}else cur+=ch;}
            fields.push(cur.trim()); return fields.map(f=>f.replace(/^"|"$/g,''));
        };
        const parseEventsCsv = (csv) => { const lines=csv.trim().split('\n').slice(1); const evts=[]; lines.forEach(l=>{if(!l.trim())return;const[d,...ep]=parseCsvLine(l);const es=ep.map(e=>e.trim().replace(/"/g,'')).filter(e=>e);if(d&&es.length>0)evts.push({date:d,events:es});}); return evts; };
        const parseHolidaysCsv = (csv) => { const lines=csv.trim().split('\n').slice(1); const h=[]; lines.forEach(l=>{if(!l.trim())return;const[ds,nm]=parseCsvLine(l);const d=parseDate(ds);if(d&&nm)h.push({date:d,name:nm.trim()});}); return h; };
        const parseTeachersCsv = (csv) => { const lines=csv.trim().split('\n').slice(1); const d=[]; lines.forEach(l=>{if(!l.trim())return;const[ds,_,t]=parseCsvLine(l);const dt=parseDate(ds);if(dt&&t&&t.trim())d.push({date:dt,teacher:t.trim()});}); return d; };

        /* [ìˆ˜ì •1] ìƒ‰ìƒ: -200 íŒŒìŠ¤í…” + ê²€ì • ê¸€ì”¨ */
        const EVENT_COLORS = [
            {bg:'bg-sky-200',text:'text-black'},{bg:'bg-emerald-200',text:'text-black'},
            {bg:'bg-amber-200',text:'text-black'},{bg:'bg-violet-200',text:'text-black'},
            {bg:'bg-rose-200',text:'text-black'},{bg:'bg-lime-200',text:'text-black'},
            {bg:'bg-indigo-200',text:'text-black'},{bg:'bg-green-200',text:'text-black'},
            {bg:'bg-pink-200',text:'text-black'},{bg:'bg-orange-200',text:'text-black'}
        ];
        const simpleHash=(s)=>{let h=0;for(let i=0;i<s.length;i++){h=(h<<5)-h+s.charCodeAt(i);h|=0;}return Math.abs(h);};

        const getEventColor = (t) => {
            for(const kw of ['ììœ¨','ì ì‘','ë™ì•„ë¦¬','ë´‰ì‚¬']) if(t.includes(kw)) return 'bg-teal-200 text-black';
            const sp={'ê³ ì‚¬':'bg-red-200 text-black font-bold','í‰ê°€':'bg-red-200 text-black font-bold','ì‹œí—˜':'bg-red-200 text-black font-bold','ë°©í•™':'bg-blue-200 text-black','ê°œí•™':'bg-blue-200 text-black','ì¡¸ì—…':'bg-purple-200 text-black','ì…í•™':'bg-purple-200 text-black'};
            for(const k in sp) if(t.includes(k)) return sp[k];
            const th=[{kw:['ì¸ë¬¸','ë…ì„œ'],c:'bg-purple-200 text-black'},{kw:['ê³¼í•™'],c:'bg-blue-200 text-black'},{kw:['ì˜ˆìˆ ','ë¯¸ìˆ ','ìŒì•…'],c:'bg-rose-200 text-black'},{kw:['ì²´ìœ¡','ìŠ¤í¬ì¸ ','ìˆ˜ë ¨íšŒ'],c:'bg-lime-200 text-black'},{kw:['êµì›','êµì§ì›íšŒì˜','ì—°ìˆ˜','í˜‘ì˜íšŒ'],c:'bg-yellow-200 text-black'}];
            for(const x of th) for(const k of x.kw) if(t.includes(k)) return x.c;
            const c=EVENT_COLORS[simpleHash(t)%EVENT_COLORS.length]; return `${c.bg} ${c.text}`;
        };

        const findAndProcessMultiDayEvents = (map) => {
            const mde=[],processed=new Set(),sorted=Array.from(map.keys()).sort();
            for(const dk of sorted){const dd=map.get(dk);if(!dd)continue;
            for(const ev of dd.events){const eid=`${dk}_${ev.fullTitle}`;if(processed.has(eid))continue;
            const m=ev.fullTitle.match(/^(.*?)(\s*\d+ì¼ì°¨|\s*\(\d+\)|1ì¼ì°¨)?$/);const bt=m?m[1].trim():ev.fullTitle;if(!bt)continue;
            let ed=new Date(dd.date);const ids=[eid];let cd=new Date(dd.date);cd.setDate(cd.getDate()+1);let nk=formatDateKey(cd);
            while(map.has(nk)){const nd=map.get(nk);const ne=nd.events.find(e=>{const mm=e.fullTitle.match(/^(.*?)(\s*\d+ì¼ì°¨|\s*\(\d+\))?$/);return mm&&mm[1].trim()===bt;});
            if(ne){ed=new Date(nd.date);ids.push(`${nk}_${ne.fullTitle}`);}else break;cd.setDate(cd.getDate()+1);nk=formatDateKey(cd);}
            if(ed>dd.date){mde.push({id:`${bt}_${formatDateKey(dd.date)}`,start:dd.date,end:ed,title:bt,color:getEventColor(ev.fullTitle)});ids.forEach(i=>processed.add(i));}}}
            const lanes=[];mde.sort((a,b)=>a.start.getTime()-b.start.getTime());
            for(const ev of mde){let ln=0;while(true){if(!lanes.find(e=>e.lane===ln&&!(ev.start>e.end||ev.end<e.start))){lanes.push({...ev,lane:ln});break;}ln++;}}
            return {multiDayEvents:lanes,processedEventIds:processed};
        };

        /* [ìˆ˜ì •2] processCalendarData: userOverrides ì ìš© - overrideê°€ ìˆëŠ” ë‚ ì§œëŠ” CSV ëŒ€ì‹  override ì‚¬ìš© */
        const processCalendarData = (rawEvents, holidays, duties, userOverrides={}, dutyOverrides={}) => {
            const dayDataMap = new Map();
            const baseEventsMap = new Map();
            rawEvents.forEach(re => { const d=parseDate(re.date); if(d){const k=formatDateKey(d); if(!baseEventsMap.has(k))baseEventsMap.set(k,{date:d,events:[]}); re.events.forEach(t=>baseEventsMap.get(k).events.push(t));} });

            const allKeys = new Set([...baseEventsMap.keys(), ...Object.keys(userOverrides)]);
            allKeys.forEach(key => {
                const base = baseEventsMap.get(key);
                const date = base ? base.date : (()=>{const[y,m,d]=key.split('-').map(Number);return new Date(y,m-1,d);})();
                if(!dayDataMap.has(key)) dayDataMap.set(key, {date, events:[], allEvents:[], holiday:null, teacherDuty:null, baseDuty:null, isDutyOverridden:false, isOverridden:false, baseEvents:[]});
                const dd = dayDataMap.get(key);
                if(base) dd.baseEvents = [...base.events];
                const titles = userOverrides[key]!==undefined ? userOverrides[key] : (base?base.events:[]);
                dd.isOverridden = userOverrides[key]!==undefined;
                titles.forEach(t => { dd.events.push({title:t.length>15?t.substring(0,12)+'...':t, fullTitle:t, color:getEventColor(t)}); });
            });

            holidays.forEach(h => { const k=formatDateKey(h.date); if(!dayDataMap.has(k))dayDataMap.set(k,{date:h.date,events:[],allEvents:[],holiday:null,teacherDuty:null,baseDuty:null,isDutyOverridden:false,isOverridden:false,baseEvents:[]}); dayDataMap.get(k).holiday=h; });
            duties.forEach(d => { const k=formatDateKey(d.date); if(!dayDataMap.has(k))dayDataMap.set(k,{date:d.date,events:[],allEvents:[],holiday:null,teacherDuty:null,baseDuty:null,isOverridden:false,baseEvents:[]}); const dd=dayDataMap.get(k); dd.teacherDuty=d; dd.baseDuty=d.teacher; });
            // dutyOverrides ì ìš©: ê°’ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°, ë¹ˆ ë¬¸ìì—´ì´ë©´ ì‚­ì œ, nullì´ë©´ ì‚­ì œ
            for(const[k,v] of Object.entries(dutyOverrides)) {
                if(!dayDataMap.has(k)){const[y,m,d]=k.split('-').map(Number);dayDataMap.set(k,{date:new Date(y,m-1,d),events:[],allEvents:[],holiday:null,teacherDuty:null,baseDuty:null,isOverridden:false,baseEvents:[]});}
                const dd=dayDataMap.get(k); dd.isDutyOverridden=true;
                if(v && v.trim()) dd.teacherDuty={date:dd.date,teacher:v.trim()};
                else dd.teacherDuty=null;
            }

            const {multiDayEvents,processedEventIds} = findAndProcessMultiDayEvents(dayDataMap);
            // í•„í„°ë§ ì „ allEvents ë³´ì¡´ (ëª¨ë‹¬ í¸ì§‘ìš©)
            for(const[k,dd] of dayDataMap.entries()) { dd.allEvents=[...dd.events]; dd.events=dd.events.filter(e=>!processedEventIds.has(`${k}_${e.fullTitle}`)); }
            return {dayDataMap,multiDayEvents};
        };

        // === Icons ===
        const XMarkIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>;
        const PlusIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>;
        const PencilIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>;
        const TrashIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>;
        const RefreshIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>;
        const ChevronLeftIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7"/></svg>;
        const ChevronRightIcon=(p)=><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...p}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7"/></svg>;

        /* [ìˆ˜ì •2] EventModal: ëª¨ë“  ì´ë²¤íŠ¸(ë‚´ì¥+ì¶”ê°€) í¸ì§‘ ê°€ëŠ¥ + ê¸°ë³¸ê°’ ë³µì› */
        const EventModal = ({dayData, onClose, onSaveOverride, onRemoveOverride, onSaveDutyOverride, onRemoveDutyOverride}) => {
            const {date, events, allEvents, holiday, teacherDuty, baseEvents, isOverridden, baseDuty, isDutyOverridden} = dayData;
            const displayEvents = allEvents || events;
            const dateKey = formatDateKey(date);
            const [isEditing, setIsEditing] = useState(false);
            const [editingEvents, setEditingEvents] = useState([]);
            const [newEventText, setNewEventText] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [isDutyEditing, setIsDutyEditing] = useState(false);
            const [dutyText, setDutyText] = useState('');
            const formattedDate = `${date.getFullYear()}ë…„ ${date.getMonth()+1}ì›” ${date.getDate()}ì¼`;

            const startEditing = () => { setEditingEvents(displayEvents.map(e=>e.fullTitle)); setIsEditing(true); };
            const handleAddEvent = () => { if(newEventText.trim()){setEditingEvents([...editingEvents,newEventText.trim()]);setNewEventText('');} };
            const handleDeleteEvent = (i) => setEditingEvents(editingEvents.filter((_,idx)=>idx!==i));
            const handleStartEdit = (i) => { setEditingIndex(i); setEditingText(editingEvents[i]); };
            const handleSaveEdit = () => { if(editingText.trim()){const n=[...editingEvents];n[editingIndex]=editingText.trim();setEditingEvents(n);} setEditingIndex(null);setEditingText(''); };
            const handleCancelEdit = () => { setEditingIndex(null);setEditingText(''); };
            const handleSave = () => { onSaveOverride(dateKey, editingEvents); setIsEditing(false); };
            const handleCancel = () => { setIsEditing(false);setNewEventText('');setEditingIndex(null); };
            const handleRestore = () => { if(window.confirm('ì´ ë‚ ì§œì˜ ì¼ì •ì„ ê¸°ë³¸ê°’(CSV ì›ë³¸)ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){onRemoveOverride(dateKey);setIsEditing(false);} };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[85vh] flex flex-col" onClick={e=>e.stopPropagation()}>
                        <header className="p-4 border-b border-slate-200 flex justify-between items-center">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">{formattedDate}</h2>
                                {(isOverridden || isDutyOverridden) && !isEditing && !isDutyEditing && <span className="text-xs text-orange-600 font-medium">âœï¸ ì‚¬ìš©ì ìˆ˜ì •ë¨</span>}
                            </div>
                            <button onClick={onClose} className="p-1 rounded-full text-slate-400 hover:bg-slate-100"><XMarkIcon/></button>
                        </header>
                        <div className="flex-grow p-4 overflow-y-auto space-y-4">
                            {holiday && <div><h3 className="font-semibold text-slate-700 text-sm mb-1 uppercase tracking-wider">ê³µíœ´ì¼</h3><div className="p-3 bg-red-50 border border-red-200 rounded-lg"><p className="font-bold text-red-700">{holiday.name}</p></div></div>}

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-semibold text-slate-700 text-sm uppercase tracking-wider">ì¼ì •</h3>
                                    <div className="flex gap-1">
                                        {isOverridden && !isEditing && <button onClick={handleRestore} className="flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-lg hover:bg-orange-200 transition-colors" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›"><RefreshIcon/>ê¸°ë³¸ê°’ ë³µì›</button>}
                                        {!isEditing && <button onClick={startEditing} className="flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-200 transition-colors"><PencilIcon/>í¸ì§‘</button>}
                                    </div>
                                </div>

                                {isEditing ? (
                                    <div className="space-y-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        {editingEvents.length > 0 ? (
                                            <ul className="space-y-2">{editingEvents.map((txt,i) => (
                                                <li key={i} className="flex items-center gap-2">
                                                    {editingIndex===i ? (<>
                                                        <input type="text" value={editingText} onChange={e=>setEditingText(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleSaveEdit()} className="flex-1 px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" autoFocus/>
                                                        <button onClick={handleSaveEdit} className="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">í™•ì¸</button>
                                                        <button onClick={handleCancelEdit} className="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400">ì·¨ì†Œ</button>
                                                    </>) : (<>
                                                        <span className="flex-1 p-2 bg-white rounded-lg text-sm border border-blue-100">{txt}</span>
                                                        <button onClick={()=>handleStartEdit(i)} className="p-1.5 text-blue-600 hover:bg-blue-100 rounded" title="ìˆ˜ì •"><PencilIcon/></button>
                                                        <button onClick={()=>handleDeleteEvent(i)} className="p-1.5 text-red-600 hover:bg-red-100 rounded" title="ì‚­ì œ"><TrashIcon/></button>
                                                    </>)}
                                                </li>
                                            ))}</ul>
                                        ) : <p className="text-sm text-slate-400 text-center py-2">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</p>}
                                        <div className="flex items-center gap-2 pt-2 border-t border-blue-200">
                                            <input type="text" value={newEventText} onChange={e=>setNewEventText(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddEvent()} placeholder="ìƒˆ ì¼ì • ì…ë ¥..." className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                            <button onClick={handleAddEvent} disabled={!newEventText.trim()} className="flex items-center gap-1 px-3 py-2 bg-green-500 text-white text-sm font-medium rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"><PlusIcon/>ì¶”ê°€</button>
                                        </div>
                                        <div className="flex gap-2 pt-2">
                                            <button onClick={handleSave} className="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors">ì €ì¥</button>
                                            <button onClick={handleCancel} className="flex-1 px-4 py-2 bg-slate-300 text-slate-700 text-sm font-semibold rounded-lg hover:bg-slate-400 transition-colors">ì·¨ì†Œ</button>
                                        </div>
                                        {baseEvents && baseEvents.length > 0 && <button onClick={()=>setEditingEvents([...baseEvents])} className="w-full flex items-center justify-center gap-1 px-3 py-1.5 bg-orange-50 text-orange-600 text-xs font-medium rounded-lg hover:bg-orange-100 transition-colors border border-orange-200"><RefreshIcon/>CSV ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</button>}
                                    </div>
                                ) : (
                                    displayEvents.length > 0 ? (
                                        <ul className="space-y-2">{displayEvents.map((ev,i)=><li key={i} className={`p-2 rounded-lg text-sm font-medium ${ev.color}`}>{ev.fullTitle}</li>)}</ul>
                                    ) : (
                                        <div className="text-center py-4 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-300">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.<br/><span className="text-blue-600">"í¸ì§‘" ë²„íŠ¼</span>ì„ ëˆŒëŸ¬ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>
                                    )
                                )}
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-semibold text-slate-700 text-sm uppercase tracking-wider">íŠ¹ë³„ í–‰ì‚¬ / ì§€ë„ êµì‚¬</h3>
                                    <div className="flex gap-1">
                                        {isDutyOverridden && !isDutyEditing && <button onClick={()=>{onRemoveDutyOverride(dateKey);}} className="flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-lg hover:bg-orange-200 transition-colors" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›"><RefreshIcon/>ê¸°ë³¸ê°’ ë³µì›</button>}
                                        {!isDutyEditing && <button onClick={()=>{setDutyText(teacherDuty?teacherDuty.teacher:'');setIsDutyEditing(true);}} className="flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-200 transition-colors"><PencilIcon/>í¸ì§‘</button>}
                                    </div>
                                </div>
                                {isDutyEditing ? (
                                    <div className="space-y-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <input type="text" value={dutyText} onChange={e=>setDutyText(e.target.value)} onKeyPress={e=>{if(e.key==='Enter'){onSaveDutyOverride(dateKey,dutyText);setIsDutyEditing(false);}}} placeholder="ì§€ë„ êµì‚¬ ì´ë¦„ (ë¹„ìš°ë©´ ì‚­ì œ)" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                        <div className="flex gap-2">
                                            <button onClick={()=>{onSaveDutyOverride(dateKey,dutyText);setIsDutyEditing(false);}} className="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors">ì €ì¥</button>
                                            <button onClick={()=>setIsDutyEditing(false)} className="flex-1 px-4 py-2 bg-slate-300 text-slate-700 text-sm font-semibold rounded-lg hover:bg-slate-400 transition-colors">ì·¨ì†Œ</button>
                                        </div>
                                        {baseDuty && <button onClick={()=>setDutyText(baseDuty)} className="w-full flex items-center justify-center gap-1 px-3 py-1.5 bg-orange-50 text-orange-600 text-xs font-medium rounded-lg hover:bg-orange-100 transition-colors border border-orange-200"><RefreshIcon/>CSV ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</button>}
                                    </div>
                                ) : (
                                    teacherDuty ? (
                                        <div className="p-3 bg-slate-100 border border-slate-200 rounded-lg">
                                            <p className="text-slate-800 font-medium">{teacherDuty.teacher}</p>
                                            {isDutyOverridden && <span className="text-xs text-orange-600 font-medium">âœï¸ ì‚¬ìš©ì ìˆ˜ì •ë¨</span>}
                                        </div>
                                    ) : (
                                        <div className="text-center py-3 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-300">ë“±ë¡ëœ ì§€ë„ êµì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br/><span className="text-blue-600">"í¸ì§‘" ë²„íŠ¼</span>ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</div>
                                    )
                                )}
                            </div>
                        </div>
                        <footer className="p-3 bg-slate-50 border-t border-slate-200 text-right"><button onClick={onClose} className="px-4 py-2 bg-slate-600 text-white text-sm font-semibold rounded-lg hover:bg-slate-700">ë‹«ê¸°</button></footer>
                    </div>
                </div>
            );
        };

        // === MiniCalendar ===
        const MiniCalendar = ({date, startOfWeek}) => {
            const ms=startOfMonth(date),me=endOfMonth(date),cs=dateFnsStartOfWeek(ms,{weekStartsOn:startOfWeek}),ce=endOfWeek(me,{weekStartsOn:startOfWeek});
            const days=eachDayOfInterval({start:cs,end:ce}); let dh=['S','M','T','W','T','F','S']; if(startOfWeek===1)dh.push(dh.shift());
            return(<div className="w-48"><h3 className="text-center font-semibold text-sm mb-2 text-slate-700">{format(date,'MMMM yyyy')}</h3>
            <div className="grid grid-cols-7 text-center text-xs text-slate-500">{dh.map(d=><div key={d} className="h-4 flex items-center justify-center">{d}</div>)}</div>
            <div className="grid grid-cols-7 text-center text-xs mt-1">{days.map(d=>{const dw=d.getDay(),cm=isSameMonth(d,date);let tc='text-slate-600';if(!cm)tc='text-slate-300';else if(dw===0)tc='text-red-500';else if(dw===6)tc='text-blue-500';return(<div key={d.toString()} className={`w-6 h-4 flex items-center justify-center rounded-full ${isToday(d)?'bg-blue-600 text-white shadow-md':tc}`}>{format(d,'d')}</div>);})}</div></div>);
        };

        // === Header ===
        const Header = ({viewDate, setViewDate, startOfWeek, setStartOfWeek, onReset, onShowDataModal, schoolName, schoolLogo}) => {
            const cy=viewDate.getFullYear(),cm=viewDate.getMonth();
            const prev=()=>setViewDate(new Date(cy,cm-1,1)), next=()=>setViewDate(new Date(cy,cm+1,1)), today=()=>setViewDate(new Date());
            const pm=new Date(cy,cm-1,1),nm=new Date(cy,cm+1,1);
            const selCls="bg-white text-slate-700 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50";
            const btnCls="px-3 py-2 border border-gray-300 bg-white text-slate-700 text-sm font-medium rounded-md shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500";
            return(
                <header className="bg-white shadow-sm sticky top-0 z-20">
                    <div className="p-2 flex justify-between items-center gap-4">
                        <div className="hidden lg:block"><MiniCalendar date={pm} startOfWeek={startOfWeek}/></div>
                        <div className="text-center p-4 sm:p-6 rounded-xl shadow-lg bg-gradient-to-r from-sky-500 to-indigo-600 text-white select-none flex-grow">
                            <h1 className="text-2xl sm:text-3xl font-bold">ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¿¨ ìº˜ë¦°ë”</h1>
                            <p className="text-sm sm:text-base mt-1">{schoolName?schoolName+" ":""}í•™ì‚¬ ì¼ì • ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                        </div>
                        <div className="hidden lg:block"><MiniCalendar date={nm} startOfWeek={startOfWeek}/></div>
                    </div>
                    <div className="p-2 border-t border-slate-200 flex items-center justify-between flex-wrap gap-2">
                        <div className="flex items-center gap-2 sm:gap-4">
                            {schoolLogo?<img src={schoolLogo} alt="Logo" className="h-8 sm:h-10 object-contain"/>:<span className="font-bold text-xl text-slate-700">ğŸ«</span>}
                            <button onClick={today} className={btnCls}>ì˜¤ëŠ˜</button>
                        </div>
                        <div className="flex items-center absolute left-1/2 -translate-x-1/2">
                            <button onClick={prev} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors"><ChevronLeftIcon/></button>
                            <h2 className="text-lg font-semibold text-slate-800 w-32 text-center">{`${cy}ë…„ ${cm+1}ì›”`}</h2>
                            <button onClick={next} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors"><ChevronRightIcon/></button>
                        </div>
                        <div className="flex items-center gap-2">
                            <select value={startOfWeek} onChange={e=>setStartOfWeek(Number(e.target.value))} className={selCls}><option value={0}>ì¼ìš”ì¼ ì‹œì‘</option><option value={1}>ì›”ìš”ì¼ ì‹œì‘</option></select>
                            <button onClick={onShowDataModal} className="px-3 py-2 border border-gray-300 bg-blue-50 text-blue-700 text-sm font-medium rounded-md shadow-sm hover:bg-blue-100">ë°ì´í„° ì„¤ì •</button>
                            <button onClick={onReset} className="px-3 py-2 border border-gray-300 bg-red-50 text-red-700 text-sm font-medium rounded-md shadow-sm hover:bg-red-100">ë°ì´í„° ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </header>
            );
        };

        // === DayCell ===
        const DayCell = ({date, dayData, isToday:isTodayFlag, isCurrentMonth, reservedHeight, onClick}) => {
            const dn=date.getDate(),dw=date.getDay();
            const dnc=dayData?.holiday?'text-red-500':dw===0?'text-red-500':dw===6?'text-blue-500':isCurrentMonth?'text-slate-700':'text-slate-400';
            const MAX=3,evts=dayData?.events||[],items=[];let rem=MAX;
            if(dayData?.holiday){items.push({type:'holiday',content:dayData.holiday});rem--;}
            evts.forEach(e=>{if(rem>0){items.push({type:'event',content:e});rem--;}});
            const total=(dayData?.holiday?1:0)+evts.length,more=total-items.length;
            return(
                <div className={`border-b border-r border-slate-300 flex flex-col relative transition-all duration-200 cursor-pointer ${isCurrentMonth?'bg-gradient-to-br from-white to-slate-50':'bg-gradient-to-br from-slate-50/80 to-slate-100/60'} hover:shadow-md hover:border-blue-300`}
                    style={{boxShadow:isCurrentMonth?'inset 1px 1px 0 rgba(255,255,255,0.9), inset -1px -1px 0 rgba(0,0,0,0.05), 0 3px 8px rgba(59,130,246,0.12)':'inset 1px 1px 0 rgba(255,255,255,0.6), inset -1px -1px 0 rgba(0,0,0,0.02), 0 2px 4px rgba(0,0,0,0.05)'}}
                    onClick={()=>onClick(dayData||{date,events:[],allEvents:[],holiday:null,teacherDuty:null,baseDuty:null,isDutyOverridden:false,isOverridden:false,baseEvents:[]})}>
                    <div className="flex-shrink-0 p-1 text-center">
                        <div className={`text-sm font-bold mx-auto transition-all duration-150 ${dnc} ${isTodayFlag?'bg-gradient-to-b from-blue-500 to-blue-700 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-lg shadow-blue-400/40':'w-7 h-7 flex items-center justify-center'}`}
                             style={!isTodayFlag&&isCurrentMonth?{textShadow:'0 1px 2px rgba(0,0,0,0.1)',fontWeight:'600'}:{}}>{dn}</div>
                        {(dayData?.isOverridden || dayData?.isDutyOverridden) && <div className="absolute top-1 right-1 text-xs" title="ì‚¬ìš©ì ìˆ˜ì •ë¨">âœï¸</div>}
                    </div>
                    <div className="flex-grow overflow-y-auto px-1 pb-1 space-y-1">
                        <div style={{height:reservedHeight}} aria-hidden="true"/>
                        {items.map((it,i)=>{
                            if(it.type==='holiday') return <div key={i} className="text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis bg-gradient-to-b from-red-100 to-red-50 text-red-700 font-medium shadow-sm border border-red-200/50" style={{boxShadow:'0 2px 4px rgba(239,68,68,0.15), inset 0 1px 0 rgba(255,255,255,0.8)'}}>{it.content.name}</div>;
                            if(it.type==='event') return <div key={i} className={`text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis ${it.content.color} font-medium shadow-sm border border-opacity-30`} style={{boxShadow:'0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6)'}}>{it.content.title}</div>;
                            return null;
                        })}
                        {more>0 && <div className="text-xs text-slate-500 font-medium px-1.5 py-0.5">+ {more} more</div>}
                    </div>
                    {dayData?.teacherDuty && <div className="flex-shrink-0 p-1 text-center text-xs font-medium text-slate-600 truncate border-t border-slate-200 mt-1 bg-gradient-to-r from-slate-50/50 to-slate-50" style={{boxShadow:'inset 0 1px 0 rgba(255,255,255,0.8)'}}>{dayData.teacherDuty.teacher}</div>}
                </div>
            );
        };

        // === Calendar ===
        const Calendar = ({viewDate, startOfWeek:sow, calendarData, onDayClick}) => {
            const y=viewDate.getFullYear(),m=viewDate.getMonth();
            const fd=new Date(y,m,1),ld=new Date(y,m+1,0);
            const sd=new Date(fd); sd.setDate(sd.getDate()-((fd.getDay()-sow+7)%7));
            const ed=new Date(ld); ed.setDate(ed.getDate()+(6-(ld.getDay()-sow+7)%7));
            const weeks=[];let cw=[],cd=new Date(sd);
            while(cd<=ed){cw.push(new Date(cd));if(cw.length===7){weeks.push(cw);cw=[];}cd.setDate(cd.getDate()+1);}
            if(cw.length>0)weeks.push(cw);
            const dh=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ']; if(sow===1)dh.push(dh.shift());
            const todayKey=formatDateKey(new Date());
            const getWkMDE=(wk)=>{if(!calendarData)return[];const ws=wk[0],we=wk[6];we.setHours(23,59,59,999);return calendarData.multiDayEvents.filter(e=>e.start<=we&&e.end>=ws);};
            const thH='1.8rem',mdH='1.4rem';
            return(
                <div className="border-t border-l border-slate-300 bg-white flex flex-col flex-grow shadow-lg rounded-xl overflow-hidden">
                    <div className="grid grid-cols-7">{dh.map((d,i)=><div key={i} className="bg-blue-600 text-white text-center py-2 text-sm font-semibold border-r border-b border-blue-700">{d}</div>)}</div>
                    <div className="flex-grow grid grid-rows-auto">
                        {weeks.map((wk,wi)=>{
                            const mde=getWkMDE(wk); const ml=mde.length>0?Math.max(...mde.map(e=>e.lane))+1:0; const rh=`calc(${ml} * ${mdH})`;
                            return(
                                <div key={wi} className="grid grid-cols-7 relative border-b border-slate-300" style={{minHeight:'120px'}}>
                                    {mde.map(ev=>{
                                        const ws=new Date(wk[0]);ws.setHours(0,0,0,0);const es=new Date(ev.start);es.setHours(0,0,0,0);const ee=new Date(ev.end);ee.setHours(0,0,0,0);
                                        const si=Math.max(0,Math.round((es-ws)/864e5)),ei=Math.min(6,Math.round((ee-ws)/864e5)),sp=ei-si+1;
                                        if(sp<=0)return null;
                                        return <div key={ev.id} className={`absolute text-xs p-1 rounded overflow-hidden text-ellipsis whitespace-nowrap ${ev.color} font-semibold shadow-md`}
                                            style={{top:`calc(${thH} + ${ev.lane} * ${mdH})`,left:`calc(${(100/7)*si}% + 2px)`,width:`calc(${(100/7)*sp}% - 4px)`,height:`calc(${mdH} - 2px)`,zIndex:5}}>{ev.title}</div>;
                                    })}
                                    {wk.map(d=>{const dk=formatDateKey(d);return <DayCell key={dk} date={d} dayData={calendarData?.dayDataMap.get(dk)} isToday={dk===todayKey} isCurrentMonth={d.getMonth()===m} reservedHeight={rh} onClick={onDayClick}/>;})}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // === Storage ===
        const SM = {
            saveEvents:c=>localStorage.setItem('schoolEvents',c), saveHolidays:c=>localStorage.setItem('schoolHolidays',c),
            saveSpecialEvents:c=>localStorage.setItem('schoolSpecialEvents',c), saveSchoolName:n=>localStorage.setItem('schoolName',n),
            saveLogo:d=>localStorage.setItem('schoolLogo',d), removeLogo:()=>localStorage.removeItem('schoolLogo'),
            saveOverrides:o=>localStorage.setItem('userOverrides',JSON.stringify(o)),
            getOverrides:()=>{const d=localStorage.getItem('userOverrides');return d?JSON.parse(d):{};},
            saveDutyOverrides:o=>localStorage.setItem('dutyOverrides',JSON.stringify(o)),
            getDutyOverrides:()=>{const d=localStorage.getItem('dutyOverrides');return d?JSON.parse(d):{};},
            getEvents:()=>localStorage.getItem('schoolEvents'), getHolidays:()=>localStorage.getItem('schoolHolidays'),
            getSpecialEvents:()=>localStorage.getItem('schoolSpecialEvents'), getSchoolName:()=>localStorage.getItem('schoolName'),
            getLogo:()=>localStorage.getItem('schoolLogo'),
            clearData:()=>{['schoolEvents','schoolHolidays','schoolSpecialEvents','schoolName','schoolLogo','userOverrides','dutyOverrides'].forEach(k=>localStorage.removeItem(k));}
        };

        // === DataUploadModal ===
        const DataUploadModal = ({onDataLoaded, onClose}) => {
            const [sn,setSn]=useState(SM.getSchoolName()||'');const[ev,setEv]=useState(null);const[hd,setHd]=useState(null);const[se,setSe]=useState(null);
            const[logo,setLogo]=useState(SM.getLogo());const[uf,setUf]=useState({events:false,holidays:false,specialEvents:false,logo:false});const[err,setErr]=useState('');
            const hfc=(e,type)=>{const f=e.target.files[0];if(!f)return;setErr('');
                if(type==='logo'){const r=new FileReader();r.onload=ev=>{setLogo(ev.target.result);setUf(p=>({...p,logo:true}));};r.onerror=()=>setErr("ë¡œê³  ì½ê¸° ì˜¤ë¥˜");r.readAsDataURL(f);return;}
                const fn=f.name.toLowerCase(),isXl=fn.endsWith('.xlsx')||fn.endsWith('.xls');
                const cb=csv=>{if(type==='events')setEv(csv);else if(type==='holidays')setHd(csv);else setSe(csv);setUf(p=>({...p,[type]:true}));setErr('');};
                const onE=msg=>{setErr(msg);setUf(p=>({...p,[type]:false}));};
                if(isXl)processExcelFile(f,cb,onE);else processCsvFile(f,cb,onE);
            };
            const submit=()=>{if(!sn.trim()){setErr('í•™êµëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}SM.saveSchoolName(sn);if(ev)SM.saveEvents(ev);if(hd)SM.saveHolidays(hd);if(se)SM.saveSpecialEvents(se);if(logo)SM.saveLogo(logo);
                onDataLoaded({schoolName:sn,events:ev||SM.getEvents(),holidays:hd||SM.getHolidays(),specialEvents:se||SM.getSpecialEvents(),logo});};
            return(
                <div className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
                        <h1 className="text-3xl font-bold text-slate-800 mb-6">ë°ì´í„° ì„¤ì •</h1>
                        <div className="space-y-6">
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">í•™êµ ì •ë³´</h2>
                                <div className="mb-4"><label className="block text-sm font-medium text-slate-700 mb-2">í•™êµëª… *</label><input type="text" placeholder="ì˜ˆ: ì›ë¬µê³ ë“±í•™êµ" value={sn} onChange={e=>setSn(e.target.value)} maxLength={50} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"/></div>
                                <div className="mb-4"><label className="block text-sm font-medium text-slate-700 mb-2">í•™êµ ë¡œê³  <span className="text-xs text-slate-500">(ì„ íƒ)</span></label>
                                <div className="flex items-center gap-2"><input type="file" accept="image/*" onChange={e=>hfc(e,'logo')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm"/>{uf.logo&&<span className="text-green-600 font-semibold">âœ“</span>}</div>
                                {logo&&<div className="mt-3 flex items-center gap-3"><img src={logo} alt="Logo" className="h-20 object-contain"/><button onClick={()=>{setLogo(null);setUf(p=>({...p,logo:false}));SM.removeLogo();}} className="px-3 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 text-sm">ì‚­ì œ</button></div>}</div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">í•™ì‚¬ì¼ì • ë°ì´í„° ì—…ë¡œë“œ</h2>
                                <p className="text-xs text-slate-500 mb-4">CSV ë˜ëŠ” XLSX íŒŒì¼</p>
                                {[['í•™ì‚¬ì¼ì •','events','ë‚ ì§œ, í–‰ì‚¬1, í–‰ì‚¬2...'],['ê³µíœ´ì¼','holidays','ë‚ ì§œ, ê³µíœ´ì¼ëª…'],['íŠ¹ë³„ í–‰ì‚¬','specialEvents','ë‚ ì§œ, ìš”ì¼, ì§€ë„êµì‚¬']].map(([label,type,hint])=>(
                                    <div key={type} className="mb-4"><label className="block text-sm font-medium text-slate-700 mb-2">{label} <span className="text-xs text-slate-500">({hint})</span></label>
                                    <div className="flex items-center gap-2"><input type="file" accept=".csv,.xlsx,.xls" onChange={e=>hfc(e,type)} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm"/>{uf[type]&&<span className="text-green-600 font-semibold">âœ“</span>}</div></div>
                                ))}
                            </div>
                            {err&&<div className="p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm">{err}</div>}
                            <div className="flex gap-3 pt-4"><button onClick={submit} className="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">ì €ì¥í•˜ê³  ë‹«ê¸°</button><button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-400">ì·¨ì†Œ</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        // === App ===
        const App = () => {
            const[red,setRed]=useState('');const[rhd,setRhd]=useState('');const[rdd,setRdd]=useState('');
            const[logo,setLogo]=useState(null);const[sdm,setSdm]=useState(false);const[vd,setVd]=useState(new Date());
            const[sow,setSow]=useState(0);const[sel,setSel]=useState(null);const[sn,setSn]=useState('');
            const[uo,setUo]=useState({});
            const[duo,setDuo]=useState({});

            useEffect(()=>{
                const saved=SM.getSchoolName();
                if(saved){setSn(saved);setLogo(SM.getLogo()||DEFAULT_LOGO_DATA_URL);setRed(SM.getEvents()||'');setRhd(SM.getHolidays()||'');setRdd(SM.getSpecialEvents()||'');setUo(SM.getOverrides());setDuo(SM.getDutyOverrides());}
                else{SM.saveSchoolName(DEFAULT_SCHOOL_NAME);SM.saveLogo(DEFAULT_LOGO_DATA_URL);SM.saveEvents(rawEventsCsv);SM.saveHolidays(rawHolidaysCsv);SM.saveSpecialEvents(rawDutiesCsv);
                    setSn(DEFAULT_SCHOOL_NAME);setLogo(DEFAULT_LOGO_DATA_URL);setRed(rawEventsCsv);setRhd(rawHolidaysCsv);setRdd(rawDutiesCsv);}
            },[]);

            const re=useMemo(()=>parseEventsCsv(red),[red]);
            const hd=useMemo(()=>parseHolidaysCsv(rhd),[rhd]);
            const du=useMemo(()=>parseTeachersCsv(rdd),[rdd]);
            const cd=useMemo(()=>processCalendarData(re,hd,du,uo,duo),[re,hd,du,uo,duo]);

            const handleDataLoaded=(d)=>{setSn(d.schoolName);setRed(d.events);setRhd(d.holidays);setRdd(d.specialEvents);if(d.logo)setLogo(d.logo);setSdm(false);};
            const handleReset=()=>{if(window.confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){SM.clearData();SM.saveSchoolName(DEFAULT_SCHOOL_NAME);SM.saveLogo(DEFAULT_LOGO_DATA_URL);SM.saveEvents(rawEventsCsv);SM.saveHolidays(rawHolidaysCsv);SM.saveSpecialEvents(rawDutiesCsv);
                setSn(DEFAULT_SCHOOL_NAME);setLogo(DEFAULT_LOGO_DATA_URL);setRed(rawEventsCsv);setRhd(rawHolidaysCsv);setRdd(rawDutiesCsv);setUo({});setDuo({});setSdm(false);}};

            const handleSaveOverride=useCallback((dk,list)=>{setUo(p=>{const n={...p,[dk]:list};SM.saveOverrides(n);return n;});setSel(null);},[]);
            const handleRemoveOverride=useCallback((dk)=>{setUo(p=>{const n={...p};delete n[dk];SM.saveOverrides(n);return n;});setSel(null);},[]);
            const handleSaveDutyOverride=useCallback((dk,text)=>{setDuo(p=>{const n={...p,[dk]:text};SM.saveDutyOverrides(n);return n;});setSel(null);},[]);
            const handleRemoveDutyOverride=useCallback((dk)=>{setDuo(p=>{const n={...p};delete n[dk];SM.saveDutyOverrides(n);return n;});setSel(null);},[]);
            const handleDayClick=useCallback((dd)=>setSel(dd),[]);

            return(
                <div className="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl flex flex-col min-h-[85vh] overflow-hidden">
                    <Header viewDate={vd} setViewDate={setVd} startOfWeek={sow} setStartOfWeek={setSow} onReset={handleReset} onShowDataModal={()=>setSdm(true)} schoolName={sn} schoolLogo={logo}/>
                    <main className="flex-grow p-1 sm:p-2 lg:p-4"><Calendar viewDate={vd} startOfWeek={sow} calendarData={cd} onDayClick={handleDayClick}/></main>
                    <footer className="p-2 text-center text-xs text-slate-500 border-t border-slate-200">Â© 2026 KH KIM. All Rights Reserved.</footer>
                    {sel&&<EventModal dayData={sel} onClose={()=>setSel(null)} onSaveOverride={handleSaveOverride} onRemoveOverride={handleRemoveOverride} onSaveDutyOverride={handleSaveDutyOverride} onRemoveDutyOverride={handleRemoveDutyOverride}/>}
                    {sdm&&<DataUploadModal onDataLoaded={handleDataLoaded} onClose={()=>setSdm(false)}/>}
                </div>
            );
        };

        const root=ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App/></React.StrictMode>);
    </script>
</body>
</html>
